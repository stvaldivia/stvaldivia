{% extends "base.html" %}
{% block title %}Ventas No Entregadas{% endblock %}

{% block titulo_sistema %}
{% endblock %}

{% block content %}

<h2 style="margin: 0 0 20px 0;">‚ö†Ô∏è Ventas No Entregadas ({{ total_pendientes }} total) - Mostrar 20</h2>
<p style="color: #aaa; margin-bottom: 30px;">Ventas con items pendientes de entregar</p>

<!-- Paginaci√≥n -->
{% if total_pages > 1 %}
<div style="margin: 20px 0; text-align: center;">
    <span style="color: #aaa;">P√°gina {{ current_page }} de {{ total_pages }}</span>
    <div style="margin-top: 10px;">
        {% if has_prev %}
        <a href="{{ url_for('routes.admin_logs_pendientes', page=current_page-1) }}" class="btn btn-primary">Anterior</a>
        {% endif %}
        {% if has_next %}
        <a href="{{ url_for('routes.admin_logs_pendientes', page=current_page+1) }}" class="btn btn-primary">Siguiente</a>
        {% endif %}
    </div>
</div>
{% endif %}

<table id="pendientes-table" style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333;">Venta</th>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333;">Producto</th>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333; text-align: center;">Vendido</th>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333; text-align: center;">Entregado</th>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333; text-align: center;">Pendiente</th>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333;">Vendedor</th>
            <th style="padding: 10px; border: 1px solid #444; background-color: #333;">Fecha Venta</th>
        </tr>
    </thead>
    <tbody id="pendientes-tbody">
        {% if pendientes %}
            {% for item in pendientes %}
            <tr style="background-color: {% if loop.index % 2 == 0 %}#1a1a1a{% else %}#222{% endif %}; {% if item.pendiente > 0 %}border-left: 4px solid #ff9800;{% endif %}">
                <td style="padding: 10px; border: 1px solid #444; color: #4caf50; font-weight: bold;">{{ item.sale_id }}</td>
                <td style="padding: 10px; border: 1px solid #444;">{{ item.item_name }}</td>
                <td style="padding: 10px; border: 1px solid #444; text-align: center; font-weight: bold;">{{ item.qty_vendido }}</td>
                <td style="padding: 10px; border: 1px solid #444; text-align: center; color: #4caf50;">{{ item.qty_entregado }}</td>
                <td style="padding: 10px; border: 1px solid #444; text-align: center; color: #ff9800; font-weight: bold; font-size: 1.1em;">{{ item.pendiente }}</td>
                <td style="padding: 10px; border: 1px solid #444; color: #aaa;">{{ item.vendedor }}</td>
                <td style="padding: 10px; border: 1px solid #444; color: #666; font-size: 0.9em;">{{ item.fecha_venta }}</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="7" style="padding: 40px; text-align: center; color: #666;">
                    {% if api_error %}
                        <div style="padding: 20px;">
                            <p style="color: #ff9800; font-size: 1.1em; margin-bottom: 10px;">
                                ‚ö†Ô∏è No se pudo conectar con la API POS
                            </p>
                            <p style="color: #aaa; margin-bottom: 15px;">
                                El endpoint /sales est√° devolviendo error 500. Verifica la configuraci√≥n de la API.
                            </p>
                            <p style="color: #888; font-size: 0.9em;">
                                {% if total_pendientes == 0 %}
                                    No se encontraron items pendientes en las entregas registradas localmente.
                                    <br>Para ver todos los tickets pendientes, la API POS debe estar funcionando.
                                {% else %}
                                    Se encontraron {{ total_pendientes }} items pendientes en ventas con entregas parciales.
                                {% endif %}
                            </p>
                        </div>
                    {% else %}
                        ‚úÖ No hay ventas pendientes de entregar
                    {% endif %}
                </td>
            </tr>
        {% endif %}
    </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const socket = io('/admin_logs');
    
    socket.on('connect', function() {
        console.log('‚úÖ WebSocket conectado para pendientes');
    });

    socket.on('disconnect', function(reason) {
        console.log('‚ùå WebSocket desconectado:', reason);
    });

    socket.on('new_log', function(data) {
        console.log('üì¶ Nueva entrega registrada, recargando...');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    });
    
    // Actualizaci√≥n autom√°tica cada 30 segundos
    let lastUpdateTime = new Date().getTime();
    let isUpdating = false;
    
    async function checkForUpdates() {
        if (isUpdating) return;
        
        try {
            const currentTime = new Date().getTime();
            const timeSinceLastUpdate = currentTime - lastUpdateTime;
            
            if (timeSinceLastUpdate >= 30000) {
                console.log('üîÑ Verificando actualizaciones de pendientes...');
                isUpdating = true;
                lastUpdateTime = currentTime;
                window.location.reload();
            }
        } catch (error) {
            console.error('‚ùå Error al verificar actualizaciones:', error);
            isUpdating = false;
        }
    }
    
    // Eliminado: actualizaci√≥n autom√°tica para reducir carga en API
    // Los logs se actualizan solo al recargar manualmente la p√°gina
});
</script>


{% endblock %}

