{% extends "base.html" %}
{% block title %}BIENVENIDX A BIMBA{% endblock %}

{% block head_extra %}
<style>
@keyframes pulseSuccess {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(0, 255, 0, 0.6); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.flash-success {
    animation: pulseSuccess 0.5s ease-in-out;
}

.flash-error {
    animation: shake 0.5s ease-in-out;
}
</style>
<script>
function changeQty(button, delta) {
    const form = button.closest('.entregar-form-tactil');
    const input = form.querySelector('.qty-input-tactil');
    const max = parseInt(button.getAttribute('data-max'));
    let currentValue = parseInt(input.value) || 1;
    let newValue = currentValue + delta;
    
    if (newValue < 1) {
        newValue = 1;
    } else if (newValue > max) {
        newValue = max;
    }
    
    input.value = newValue;
    
    // Feedback visual
    input.style.transform = 'scale(1.1)';
    setTimeout(() => {
        input.style.transform = 'scale(1)';
    }, 200);
}

// Función para enfocar el input del escáner
function focusScannerInput() {
    const scannerInput = document.getElementById('scanner-input') || document.querySelector('input[name="sale_id"]');
    if (scannerInput) {
        scannerInput.focus();
        scannerInput.select();
    }
}

// Variable global para el contador de redirección
let autoRedirectInterval = null;
let autoRedirectSeconds = 30;

// Función para cancelar la redirección automática
function cancelAutoRedirect() {
    if (autoRedirectInterval) {
        clearInterval(autoRedirectInterval);
        autoRedirectInterval = null;
    }
    const countdownElement = document.getElementById('countdown');
    if (countdownElement) {
        countdownElement.remove();
    }
}

// Función para iniciar el contador de redirección
function startAutoRedirect() {
    // Cancelar cualquier contador existente
    cancelAutoRedirect();
    
    const successMessages = document.querySelectorAll('.flash-success');
    let deliveryMessage = null;
    
    successMessages.forEach(function(msg) {
        if (msg.textContent.toLowerCase().includes('entregado')) {
            deliveryMessage = msg;
        }
    });
    
    if (!deliveryMessage) return;
    
    // Crear elemento para mostrar el contador
    const countdownElement = document.createElement('div');
    countdownElement.style.marginTop = '8px';
    countdownElement.style.fontSize = '0.9rem';
    countdownElement.style.color = '#fff';
    countdownElement.style.fontWeight = 'normal';
    countdownElement.id = 'countdown';
    deliveryMessage.appendChild(countdownElement);
    
    autoRedirectSeconds = 30;
    
    const updateCountdown = function() {
        if (autoRedirectSeconds > 0 && autoRedirectInterval) {
            countdownElement.textContent = `Volviendo al escaneo en ${autoRedirectSeconds} segundos (sin interacción)...`;
            autoRedirectSeconds--;
        } else {
            cancelAutoRedirect();
            // Redirigir al home de escaneo (sin parámetros)
            window.location.href = '{{ url_for("routes.scanner") }}';
        }
    };
    
    // Iniciar el contador
    updateCountdown();
    autoRedirectInterval = setInterval(updateCountdown, 1000);
}

// Función para reproducir sonido de éxito
function playSuccessSound() {
    // Crear un sonido usando Web Audio API (sin necesidad de archivos externos)
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Frecuencia ascendente (sonido de éxito)
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    } catch (e) {
        console.log('No se pudo reproducir sonido:', e);
    }
}

// Función para reproducir sonido de error
function playErrorSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Frecuencia descendente (sonido de error)
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.2);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
    } catch (e) {
        console.log('No se pudo reproducir sonido:', e);
    }
}

// Redirección automática después de entregar
document.addEventListener('DOMContentLoaded', function() {
    // Enfocar el input del escáner cuando no hay items (pantalla de escaneo)
    if (!document.querySelector('.productos')) {
        // Pequeño delay para asegurar que el input esté disponible después de la carga completa
        setTimeout(focusScannerInput, 300);
    }
    
    // Verificar si hay un mensaje de éxito (indicando que se acaba de entregar)
    const successMessages = document.querySelectorAll('.flash-success');
    
    if (successMessages.length > 0) {
        // Verificar si el mensaje contiene "entregado" (indica entrega exitosa)
        let hasDeliveryMessage = false;
        
        successMessages.forEach(function(msg) {
            if (msg.textContent.toLowerCase().includes('entregado')) {
                hasDeliveryMessage = true;
            }
        });
        
        if (hasDeliveryMessage) {
            // Iniciar contador de 30 segundos
            startAutoRedirect();
        }
    }
    
    // Detectar interacción del usuario para cancelar la redirección automática
    const userInteractions = [
        'keydown', 'keyup', 'keypress',
        'click', 'mousedown', 'mouseup',
        'touchstart', 'touchend',
        'input', 'change'
    ];
    
    userInteractions.forEach(function(eventType) {
        document.addEventListener(eventType, function(e) {
            // Ignorar eventos del contador mismo
            if (e.target && e.target.id === 'countdown') {
                return;
            }
            // Cancelar redirección si hay interacción
            cancelAutoRedirect();
        }, { once: false });
    });
    
    // También detectar cambios en inputs específicos
    const scannerInput = document.getElementById('scanner-input') || document.querySelector('input[name="sale_id"]');
    if (scannerInput) {
        scannerInput.addEventListener('input', cancelAutoRedirect);
        scannerInput.addEventListener('change', cancelAutoRedirect);
        
        // Modo escaneo continuo: detectar Enter y buscar automáticamente
        scannerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && scannerInput.value.trim()) {
                e.preventDefault();
                const form = scannerInput.closest('form');
                if (form) {
                    form.submit();
                }
            }
        });
        
        // Detectar código completo (usualmente termina con Enter o tab)
        let lastValue = '';
        scannerInput.addEventListener('input', function(e) {
            const currentValue = e.target.value.trim();
            // Si el valor cambia significativamente (código escaneado), enfocar
            if (currentValue.length > lastValue.length + 3) {
                // Probablemente se escaneó un código completo
                setTimeout(() => {
                    if (currentValue.length >= 3) {
                        // Auto-submit si tiene un código válido y se deja de escribir
                        clearTimeout(window.scanTimeout);
                        window.scanTimeout = setTimeout(() => {
                            const form = scannerInput.closest('form');
                            if (form && currentValue.length >= 3) {
                                form.submit();
                            }
                        }, 500); // Esperar 500ms después del último cambio
                    }
                }, 100);
            }
            lastValue = currentValue;
        });
    }
    
    // Detectar cuando se presiona el botón de entregar
    const entregarButtons = document.querySelectorAll('.btn-entregar-tactil, button[type="submit"]');
    entregarButtons.forEach(function(btn) {
        btn.addEventListener('click', cancelAutoRedirect);
    });
    
    // Detectar mensajes de error y reproducir sonido
    const errorMessages = document.querySelectorAll('.flash-error, .msg-error');
    if (errorMessages.length > 0) {
        playErrorSound();
        errorMessages.forEach(function(msg) {
            msg.style.animation = 'shake 0.5s ease-in-out';
        });
    }
});

// Interceptar envío de formularios de entrega para feedback inmediato
document.addEventListener('submit', function(e) {
    const form = e.target;
    if (form.classList.contains('entregar-form-tactil')) {
        // Feedback visual inmediato
        const submitBtn = form.querySelector('.btn-entregar-tactil');
        if (submitBtn) {
            submitBtn.style.opacity = '0.6';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Procesando...';
        }
    }
});
</script>
{% endblock %}

{% block titulo_sistema %}
    {% if not items %}
        <h1 class="titulo-sistema-principal">SISTEMA DE ENTREGA DE PRODUCTOS BIMBA</h1>
    {% endif %}
{% endblock %}

{% block content %}

{# -------------------- SECCIÓN PRODUCTOS -------------------- #}
{% if items %}
    <table class="productos">
        <thead>
            <tr>
                <th>PRODUCTO</th>
                <th>CANTIDAD</th>
                <th>ENTREGADO</th>
                <th>PENDIENTE</th>
                <th>ACCIÓN</th>
            </tr>
        </thead>

        <tbody>
        {% for item in items %}
            {% set delivered = entregados_qty[(sale_id, item.name)]|default(0) %}
            {% set pending = item.quantity - delivered %}
            {% set entregas_list = entregados_todos.get((sale_id, item.name), []) %}

            <tr class="{% if pending == 0 %}completo{% else %}pendiente-disponible{% endif %}">
                <td class="producto-nombre">
                    <strong>{{ item.name }}</strong>

                    {# Mostrar modificadores #}
                    {% if item.modifier_items and item.modifier_items|length > 0 %}
                        <ul class="mods">
                        {% for modifier in item.modifier_items %}
                            {% if modifier.quantity and modifier.quantity|int > 0 %}
                                <li>{{ modifier.quantity|int }}x {{ modifier.name }}</li>
                            {% endif %}
                        {% endfor %}
                        </ul>
                    {% endif %}

                    {# Mostrar historial de entregas #}
                    {% if entregas_list %}
                        <div class="historial-entregas">
                            <strong>Entregas realizadas:</strong>
                            {% for entrega in entregas_list %}
                                <div class="entrega-item">
                                    {{ entrega.qty }}x por {{ entrega.bartender }} ({{ entrega.barra }}) - {{ entrega.timestamp }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </td>

                <td class="producto-cantidad">{{ item.quantity }}</td>
                <td class="producto-entregado">{{ delivered }}</td>
                <td class="producto-pendiente">{{ pending }}</td>

                <td class="producto-accion">
                {% if pending > 0 %}
                    <form method="POST" action="{{ url_for('routes.entregar') }}" class="entregar-form-tactil">
                        <input type="hidden" name="sale_id" value="{{ sale_id }}">
                        <input type="hidden" name="item_name" value="{{ item.name }}">
                        
                        <div class="quantity-selector-tactil">
                            <button type="button" class="qty-btn qty-minus" onclick="changeQty(this, -1)" data-max="{{ pending }}">
                                <span>-</span>
                            </button>
                            <input type="number" 
                                   name="qty" 
                                   id="qty-{{ loop.index }}" 
                                   value="1" 
                                   min="1" 
                                   max="{{ pending }}" 
                                   required
                                   class="qty-input-tactil"
                                   readonly>
                            <button type="button" class="qty-btn qty-plus" onclick="changeQty(this, 1)" data-max="{{ pending }}">
                                <span>+</span>
                            </button>
                        </div>
                        <button type="submit" class="btn-entregar-tactil">
                            <span>Entregar</span>
                        </button>
                    </form>

                {% else %}
                    <div class="entregado-completo">
                        <span class="icono-ok">✓</span>
                        <div class="entregado-info-tactil">
                            {% if entregas_list %}
                                <strong>Completado</strong>
                            {% else %}
                                <strong>Todo Entregado</strong>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

{% elif sale_id and not error %}
    <div class="msg msg-info">
        No se encontraron productos para la venta ID: {{ sale_id }} o la venta está vacía.
    </div>
{% endif %}

{# -------------------- FORM BUSCAR VENTA -------------------- #}
<div class="buscar-box-inline">
    <form method="GET" action="{{ url_for('routes.scanner') }}" class="buscar-form-inline">
        <label class="titulo-buscar-inline">Ingresar Código de Venta:</label>
        <input type="text" 
               name="sale_id" 
               id="scanner-input" 
               value="" 
               placeholder="BMB 12345 o POS 123" 
               autofocus
               autocomplete="off"
               spellcheck="false">
        <button type="submit">Buscar Venta</button>
    </form>
</div>

{# -------------------- DETALLES DE VENTA -------------------- #}
{% if venta_info_adicional %}
    <div class="venta-info-dos-lineas">
        {% if venta_info_adicional.error %}
            <h3>Detalles de Venta ID: {{ sale_id }}</h3>
            <p>{{ venta_info_adicional.error }}</p>
        {% else %}
            <h3 class="titulo-detalles-dos-lineas">Detalles de Venta ID: {{ venta_info_adicional.venta_id }}</h3>
            <div class="venta-info-columnas">
                <div class="venta-info-columna">
                    <p><strong>Fecha de Venta:</strong> {{ venta_info_adicional.fecha_venta }}</p>
                    <p><strong>Vendido por:</strong> {{ venta_info_adicional.vendido_por }}</p>
                    <p><strong>Caja:</strong> {{ venta_info_adicional.caja }}</p>
                </div>
                <div class="venta-info-columna">
                    <p><strong>Cliente:</strong> {{ venta_info_adicional.cliente }}</p>
                    <p><strong>Comentario:</strong> {{ venta_info_adicional.comentario }}</p>
                </div>
            </div>
        {% endif %}
    </div>
{% endif %}

{# -------------------- ERROR -------------------- #}
{% if error %}
    <div class="msg msg-error">{{ error }}</div>
{% endif %}

{% endblock %}