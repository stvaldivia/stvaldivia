{% extends "base.html" %}
{% block title %}Dashboard Administrativo - BIMBA{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Header -->
    <div class="admin-page-header">
        <h1 class="page-title">üè† Dashboard Administrativo</h1>
        <p style="color: var(--text-secondary); font-size: var(--text-base);">Panel de control y monitoreo en tiempo real</p>
    </div>

    <!-- Shift Status -->
    {% if shift_status.is_open %}
    <div class="card" style="margin-bottom: 20px; background: rgba(76, 175, 80, 0.1); border-left: 4px solid #4caf50;">
        <h3 style="margin: 0 0 10px 0; color: #4caf50;">üü¢ Turno Abierto</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <small style="color: #aaa; display: block;">Fiesta</small>
                <strong>{{ shift_status.fiesta_nombre or 'Sin nombre' }}</strong>
            </div>
            <div>
                <small style="color: #aaa; display: block;">Fecha</small>
                <strong>{{ shift_status.shift_date|fecha_solo if shift_status.shift_date else 'N/A' }}</strong>
            </div>
            <div>
                <small style="color: #aaa; display: block;">Tiempo Transcurrido</small>
                <strong>{{ shift_metrics.tiempo_transcurrido or 'N/A' }}</strong>
            </div>
            <div>
                <small style="color: #aaa; display: block;">Total Entregas</small>
                <strong style="color: #4caf50;">{{ shift_metrics.total_entregas or 0 }}</strong>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card" style="margin-bottom: 20px; background: rgba(255, 152, 0, 0.1); border-left: 4px solid #ff9800;">
    </div>
    {% endif %}

    <!-- Alerts Section -->
    {% if sos_requests|length > 0 or pending_closes|length > 0 or register_locks|length > 0 %}
    <div class="admin-section">
        <h2 class="admin-section-title">‚ö†Ô∏è Alertas y Notificaciones</h2>

        {% if sos_requests|length > 0 %}
        {% for request in sos_requests[:3] %}
        <div class="card"
            style="margin-bottom: 15px; background: rgba(255, 152, 0, 0.1); border-left: 4px solid #ff9800;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                <div style="flex: 1;">
                    <strong style="color: #ff9800;">üö® Solicitud de Apertura de Caj√≥n</strong>
                    <p style="margin: 5px 0 0 0; color: #aaa;">Caja {{ request.register_id }} - {{ request.employee_name
                        }}</p>
                </div>
                <a href="/admin/logs" class="btn btn-sm">Ver</a>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        {% if pending_closes|length > 0 %}
        {% for close in pending_closes[:3] %}
        <div class="card"
            style="margin-bottom: 15px; background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196f3;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                <div style="flex: 1;">
                    <strong style="color: #2196f3;">üí∞ Cierre de Caja Pendiente</strong>
                    <p style="margin: 5px 0 0 0; color: #aaa;">Caja {{ close.register_id }} - {{ close.employee_name }}
                    </p>
                </div>
                <a href="/admin/logs" class="btn btn-sm">Ver</a>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        {% if register_locks|length > 0 %}
        {% for lock in register_locks[:3] %}
        <div class="card"
            style="margin-bottom: 15px; background: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336;">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                <div style="flex: 1;">
                    <strong style="color: #f44336;">üîí Caja Bloqueada</strong>
                    <p style="margin: 5px 0 0 0; color: #aaa;">Caja {{ lock.register_id }} - Bloqueada por {{
                        lock.locked_by }}</p>
                </div>
                <a href="/admin/logs" class="btn btn-sm">Ver</a>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    {% endif %}

    <!-- Quick Actions Section -->
    <div class="admin-section">
        <h2 class="admin-section-title">‚ö° Accesos R√°pidos</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <a href="/admin/turnos" class="card"
                style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">‚è∞</div>
                    <h3 style="margin: 0 0 8px 0;">Gesti√≥n de Turnos</h3>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Abrir, cerrar y gestionar turnos del d√≠a</p>
                </div>
            </a>

            <a href="/admin/logs" class="card"
                style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üìã</div>
                    <h3 style="margin: 0 0 8px 0;">Tickets de Entregas</h3>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Ver y gestionar todos los tickets</p>
                </div>
            </a>

            <a href="/admin/inventario" class="card"
                style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üì¶</div>
                    <h3 style="margin: 0 0 8px 0;">Inventario</h3>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Control de stock y consumos</p>
                </div>
            </a>

            <a href="{{ url_for('routes.pos_stats') }}" class="card"
                style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üí∞</div>
                    <h3 style="margin: 0 0 8px 0;">Cajas y Kioskos</h3>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Estad√≠sticas de ventas y pagos</p>
                </div>
            </a>

            <a href="{{ url_for('equipo.listar') }}" class="card"
                style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üë•</div>
                    <h3 style="margin: 0 0 8px 0;">Equipo</h3>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Gestionar empleados y cargos</p>
                </div>
            </a>

            <a href="{{ url_for('routes.admin_panel_control') }}" class="card"
                style="text-decoration: none; color: inherit; transition: transform 0.2s;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üéõÔ∏è</div>
                    <h3 style="margin: 0 0 8px 0;">Panel de Control</h3>
                    <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Configuraci√≥n del sistema</p>
                </div>
            </a>
        </div>
    </div>

    <!-- Metrics Section -->
    {% if shift_status.is_open %}
    <div class="admin-section">
        <h2 class="admin-section-title">üìä M√©tricas del Turno</h2>
        <div class="admin-stats-grid">
            <div class="admin-stat-card">
                <h4>Total Entregas</h4>
                <div class="stat-value">{{ shift_metrics.total_entregas or 0 }}</div>
                <small>Productos entregados</small>
            </div>

            <div class="admin-stat-card">
                <h4>Total Entradas</h4>
                <div class="stat-value">{{ shift_metrics.total_entradas or 0 }}</div>
                <small>
                    {% if shift_metrics.entradas_5000 or shift_metrics.entradas_10000 %}
                    $5k: {{ shift_metrics.entradas_5000 or 0 }} | $10k: {{ shift_metrics.entradas_10000 or 0 }}
                    {% else %}
                    Entradas vendidas
                    {% endif %}
                </small>
            </div>

            <div class="admin-stat-card">
                <h4>Kiosko</h4>
                <div class="stat-value">${{ (shift_metrics.monto_kiosko or 0)|currency }}</div>
                <small>{{ kiosk_stats.pagos_turno or 0 }} pagos del turno</small>
            </div>

            {% if shift_metrics.peak_hour %}
            <div class="admin-stat-card">
                <h4>Hora Pico</h4>
                <div class="stat-value">{{ shift_metrics.peak_hour }}:00</div>
                <small>{{ shift_metrics.peak_hour_count }} entregas</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Stats Dashboard (Dynamic Content) -->
    <div class="admin-section">
        <div id="stats-dashboard">
            <div style="text-align: center; padding: 40px; color: #aaa;">
                <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
                <p>Cargando m√©tricas en tiempo real...</p>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Configuraci√≥n Global
    const META_VENTA_DEFAULT = 2000000; // $2.000.000
    let dashboardUpdateInterval;
    let salesChart = null;

    // Utilidades de Formato
    const formatCurrency = (value) => {
        if (value === null || value === undefined || isNaN(value)) return '$0';
        return '$' + Math.round(value).toLocaleString('es-CL');
    };

    const formatNumber = (value) => {
        if (value === null || value === undefined || isNaN(value)) return '0';
        return Math.round(value).toLocaleString('es-CL');
    };

    // Renderizado del Dashboard
    function renderDashboard(data) {
        const container = document.getElementById('stats-dashboard');

        if (!data.success) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px; color: #f44336;">‚ö†Ô∏è</div>
                    <h2>Error de Conexi√≥n</h2>
                    <p style="color: #aaa;">${data.error || 'No se pudieron cargar los datos'}</p>
                    <button onclick="updateStatsDashboard()" class="btn" style="margin-top: 20px;">Reintentar</button>
                </div>
            `;
            return;
        }

        if (!data.shift_open) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                </div>
            `;
            return;
        }

        // C√°lculos de Meta
        const metaVenta = META_VENTA_DEFAULT;
        const porcentajeMeta = Math.min(100, (data.financial.total_recaudado / metaVenta) * 100);
        const faltaParaMeta = Math.max(0, metaVenta - data.financial.total_recaudado);

        // HTML Structure
        container.innerHTML = `
            <div class="card">
                <h2 style="margin-top: 0;">üìà Estad√≠sticas de Ventas</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="card" style="background: rgba(76, 175, 80, 0.1);">
                        <small style="color: #aaa; display: block; margin-bottom: 8px;">Total Recaudado</small>
                        <div style="font-size: 2rem; font-weight: 700; color: #4caf50;">${formatCurrency(data.financial.total_recaudado)}</div>
                        <small style="color: #aaa; margin-top: 8px; display: block;">
                            üíµ ${formatCurrency(data.financial.efectivo)} | üí≥ ${formatCurrency(data.financial.debito + data.financial.credito)}
                        </small>
                    </div>
                    
                    <div class="card">
                        <small style="color: #aaa; display: block; margin-bottom: 8px;">Meta Diaria</small>
                        <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 10px;">${formatCurrency(metaVenta)}</div>
                        <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; margin-bottom: 5px;">
                            <div style="height: 100%; background: linear-gradient(90deg, #4caf50, #45a049); width: ${porcentajeMeta}%; transition: width 1s ease;"></div>
                        </div>
                        <small style="color: #aaa;">${porcentajeMeta.toFixed(1)}% completado | Faltan ${formatCurrency(faltaParaMeta)}</small>
                    </div>
                    
                    <div class="card">
                        <small style="color: #aaa; display: block; margin-bottom: 8px;">Ventas Totales</small>
                        <div style="font-size: 2rem; font-weight: 700;">${formatNumber(data.financial.total_ventas)}</div>
                        <small style="color: #aaa; margin-top: 8px; display: block;">Ticket promedio: ${formatCurrency(data.financial.ticket_promedio)}</small>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-top: 0;">üî• Top Productos</h3>
                    <div style="display: grid; gap: 10px;">
                        ${renderTopList(data.tops.productos)}
                    </div>
                </div>
            </div>
        `;

        // Initialize Chart si hay datos
        if (data.chart_data) {
            initChart(data.chart_data);
        }
    }

    function renderTopList(items) {
        if (!items || items.length === 0) {
            return '<div style="color: #aaa; text-align: center; padding: 20px;">Sin datos a√∫n</div>';
        }

        const maxVal = Math.max(...items.map(i => i.qty));

        return items.slice(0, 5).map((item, index) => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255, 255, 255, 0.02); border-radius: 8px;">
                <div style="width: 30px; height: 30px; background: ${index === 0 ? '#4caf50' : 'rgba(255, 255, 255, 0.1)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: ${index === 0 ? '#000' : '#fff'};">
                    ${index + 1}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">${item.name}</div>
                    <div style="height: 4px; background: rgba(255, 255, 255, 0.05); border-radius: 2px; overflow: hidden;">
                        <div style="height: 100%; background: #4caf50; width: ${(item.qty / maxVal) * 100}%; border-radius: 2px;"></div>
                    </div>
                </div>
                <div style="font-weight: 700;">${item.qty}</div>
            </div>
        `).join('');
    }

    function initChart(chartData) {
        const container = document.getElementById('stats-dashboard');
        const chartSection = document.createElement('div');
        chartSection.className = 'card';
        chartSection.style.marginTop = '20px';
        chartSection.innerHTML = `
            <h3 style="margin-top: 0;">üìä Tendencia de Ventas</h3>
            <div style="height: 300px; position: relative;">
                <canvas id="salesChart"></canvas>
            </div>
        `;
        container.appendChild(chartSection);

        const ctx = document.getElementById('salesChart');
        if (!ctx) return;

        const labels = chartData.labels || ['22:00', '23:00', '00:00', '01:00', '02:00', '03:00'];
        const dataPoints = chartData.data || [150000, 300000, 450000, 600000, 400000, 200000];

        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas ($)',
                    data: dataPoints,
                    borderColor: '#4caf50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#4caf50'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function (context) {
                                return formatCurrency(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.05)' },
                        ticks: { color: '#94a3b8', callback: (val) => '$' + val / 1000 + 'k' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    }

    function updateStatsDashboard() {
        fetch('/api/dashboard/stats')
            .then(response => response.json())
            .then(data => renderDashboard(data))
            .catch(err => {
                console.error('Error fetching stats:', err);
                document.getElementById('stats-dashboard').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 20px; color: #f44336;">‚ùå</div>
                        <h2>Error de Conexi√≥n</h2>
                        <p style="color: #aaa;">No se pudieron cargar las estad√≠sticas</p>
                        <button onclick="updateStatsDashboard()" class="btn" style="margin-top: 20px;">Reintentar</button>
                    </div>
                `;
            });
    }

    // Iniciar
    document.addEventListener('DOMContentLoaded', () => {
        updateStatsDashboard();
        dashboardUpdateInterval = setInterval(updateStatsDashboard, 30000); // Actualizar cada 30s
    });

    // Limpiar
    window.addEventListener('beforeunload', () => {
        if (dashboardUpdateInterval) clearInterval(dashboardUpdateInterval);
    });
</script>
{% endblock %}