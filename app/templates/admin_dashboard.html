{% extends "base.html" %}
{% block title %}Panel Administrativo{% endblock %}

{% block head_extra %}
<style>
    /* Forzar ancho completo del dashboard */
    body {
        margin: 0;
        padding: 0;
    }
    
    .container {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .main-container {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .admin-dashboard {
        width: 100%;
        height: calc(100vh - 60px);
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    
    #stats-dashboard {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    .dashboard-header-full {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 15px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        flex-shrink: 0;
        box-sizing: border-box;
    }
    
    .dashboard-footer-full {
        width: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-top: 2px solid rgba(102, 126, 234, 0.3);
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        margin: 0 -5px -5px -5px;
        box-sizing: border-box;
    }
    
    .dashboard-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 2.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .dashboard-header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .tool-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: 30px;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        display: block;
        color: inherit;
    }
    
    .tool-card:hover {
        transform: translateY(-5px);
        border-color: rgba(102, 126, 234, 0.6);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .tool-card .icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
        display: block;
    }
    
    .tool-card h3 {
        color: #e8e8e8;
        margin: 0 0 10px 0;
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .tool-card p {
        color: #aaa;
        margin: 0;
        font-size: 1rem;
        line-height: 1.5;
    }
    
    .tool-card .badge {
        display: inline-block;
        margin-top: 10px;
        padding: 5px 12px;
        background: rgba(102, 126, 234, 0.2);
        border-radius: 20px;
        font-size: 0.85rem;
        color: #667eea;
    }
    
    /* Categor√≠as */
    .category-section {
        margin-bottom: 50px;
    }
    
    .category-title {
        font-size: 1.8rem;
        color: #e8e8e8;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    }
    
    /* Colores por categor√≠a */
    .tool-card.delivery {
        border-color: rgba(76, 175, 80, 0.3);
    }
    
    .tool-card.delivery:hover {
        border-color: rgba(76, 175, 80, 0.6);
        box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
    }
    
    .tool-card.survey {
        border-color: rgba(156, 39, 176, 0.3);
    }
    
    .tool-card.survey:hover {
        border-color: rgba(156, 39, 176, 0.6);
        box-shadow: 0 10px 30px rgba(156, 39, 176, 0.3);
    }
    
    .tool-card.security {
        border-color: rgba(244, 67, 54, 0.3);
    }
    
    .tool-card.security:hover {
        border-color: rgba(244, 67, 54, 0.6);
        box-shadow: 0 10px 30px rgba(244, 67, 54, 0.3);
    }
    
    .tool-card.stats {
        border-color: rgba(255, 152, 0, 0.3);
    }
    
    .tool-card.stats:hover {
        border-color: rgba(255, 152, 0, 0.6);
        box-shadow: 0 10px 30px rgba(255, 152, 0, 0.3);
    }
    
    .shift-summary-section {
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }
    
    /* Alertas */
    .alert-banner {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        animation: slideIn 0.3s ease-out;
    }
    
    .alert-banner.warning {
        background: rgba(255, 152, 0, 0.2);
        border: 2px solid rgba(255, 152, 0, 0.5);
        color: #ff9800;
    }
    
    .alert-banner.error {
        background: rgba(244, 67, 54, 0.2);
        border: 2px solid rgba(244, 67, 54, 0.5);
        color: #f44336;
    }
    
    .alert-banner.info {
        background: rgba(102, 126, 234, 0.2);
        border: 2px solid rgba(102, 126, 234, 0.5);
        color: #667eea;
    }
    
    /* Loading state */
    .loading {
        text-align: center;
        padding: 40px;
        color: #aaa;
    }
    
    .loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    
    /* Estado sin turno */
    .no-shift-message {
        text-align: center;
        padding: 60px 20px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 15px;
        border: 2px solid rgba(102, 126, 234, 0.3);
        margin: auto;
    }
    
    .no-shift-message h2 {
        color: #e8e8e8;
        font-size: 1.8rem;
        margin-bottom: 15px;
    }
    
    .no-shift-message p {
        color: #aaa;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Dashboard de Estad√≠sticas en Tiempo Real -->
    <div id="stats-dashboard">
        <div class="loading">Cargando estad√≠sticas</div>
    </div>
</div>

<script>
// Dashboard de Estad√≠sticas en Tiempo Real
let dashboardUpdateInterval;

function formatCurrency(value) {
    if (value === null || value === undefined || isNaN(value)) return '$0';
    return '$' + Math.round(value).toLocaleString('es-CL');
}

function formatNumber(value) {
    if (value === null || value === undefined || isNaN(value)) return '0';
    return Math.round(value).toLocaleString('es-CL');
}

function formatDecimal(value, decimals = 1) {
    if (value === null || value === undefined || isNaN(value)) return '0.0';
    return parseFloat(value).toFixed(decimals);
}

function updateStatsDashboard() {
    fetch('/api/dashboard/stats')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                document.getElementById('stats-dashboard').innerHTML = `
                    <div class="no-shift-message">
                        <h2>‚ö†Ô∏è Error</h2>
                        <p>${data.error || 'No se pudieron cargar las estad√≠sticas'}</p>
                    </div>
                `;
                return;
            }
            
            if (!data.shift_open) {
                document.getElementById('stats-dashboard').innerHTML = `
                    <div class="no-shift-message">
                        <h2>üìä No hay turno abierto</h2>
                        <p>Las estad√≠sticas se mostrar√°n cuando se abra un turno</p>
                    </div>
                `;
                return;
            }
            
            // Construir HTML del dashboard
            const html = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; gap: 0; overflow: hidden;">
                    <!-- Header del Dashboard -->
                    <div class="dashboard-header-full">
                        <h1 style="color: #e8e8e8; font-size: 1.1rem; margin: 0;">üìä Dashboard BIMBA</h1>
                        <div style="display: flex; align-items: center; gap: 8px; color: #aaa; font-size: 0.8rem;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: #4caf50;"></span>
                            <span>Turno Abierto</span>
                        </div>
                    </div>
                    
                    <!-- Contenedor para el contenido -->
                    <div style="flex: 1; overflow: hidden; display: grid; grid-template-rows: auto auto auto 1fr auto; gap: 5px; min-height: 0; padding: 0 5px 0 5px; box-sizing: border-box;">
                        <!-- Resumen Financiero - Grid 2x3 -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 5px; margin-bottom: 5px;">
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 6px; text-align: center;">
                            <div style="color: #aaa; font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px;">Total Recaudado</div>
                            <div style="color: #e8e8e8; font-size: 1.2rem; font-weight: bold; line-height: 1.2;">${formatCurrency(data.financial.total_recaudado)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 6px; text-align: center;">
                            <div style="color: #aaa; font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px;">Efectivo</div>
                            <div style="color: #e8e8e8; font-size: 1.2rem; font-weight: bold; line-height: 1.2;">${formatCurrency(data.financial.efectivo)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 6px; text-align: center;">
                            <div style="color: #aaa; font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px;">D√©bito</div>
                            <div style="color: #e8e8e8; font-size: 1.2rem; font-weight: bold; line-height: 1.2;">${formatCurrency(data.financial.debito)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 6px; text-align: center;">
                            <div style="color: #aaa; font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px;">Cr√©dito</div>
                            <div style="color: #e8e8e8; font-size: 1.2rem; font-weight: bold; line-height: 1.2;">${formatCurrency(data.financial.credito)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 6px; text-align: center;">
                            <div style="color: #aaa; font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px;">Total Ventas</div>
                            <div style="color: #e8e8e8; font-size: 1.2rem; font-weight: bold; line-height: 1.2;">${formatNumber(data.financial.total_ventas)}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 6px; text-align: center;">
                            <div style="color: #aaa; font-size: 0.7rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px;">Ticket Promedio</div>
                            <div style="color: #e8e8e8; font-size: 1.2rem; font-weight: bold; line-height: 1.2;">${formatCurrency(data.financial.ticket_promedio)}</div>
                        </div>
                    </div>
                    
                    <!-- KPIs -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; margin-bottom: 5px;">
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(76, 175, 80, 0.3); border-radius: 4px; padding: 5px; text-align: center; display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 1.4rem; margin-bottom: 4px;">üë§</div>
                            <div style="color: #e8e8e8; font-size: 1rem; font-weight: bold; margin-bottom: 2px;">${formatCurrency(data.kpis.por_persona)}</div>
                            <div style="color: #aaa; font-size: 0.65rem; line-height: 1.1;">Por Persona<br>Recaudaci√≥n / Personas</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 4px; padding: 5px; text-align: center; display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 1.4rem; margin-bottom: 4px;">üìà</div>
                            <div style="color: #e8e8e8; font-size: 1rem; font-weight: bold; margin-bottom: 2px;">${formatCurrency(data.kpis.proyeccion)}</div>
                            <div style="color: #aaa; font-size: 0.65rem; line-height: 1.1;">Proyecci√≥n<br>Estimado al cierre</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 4px; padding: 5px; text-align: center; display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 1.4rem; margin-bottom: 4px;">‚ö°</div>
                            <div style="color: #e8e8e8; font-size: 1rem; font-weight: bold; margin-bottom: 2px;">${formatDecimal(data.kpis.entregas_por_hora)}</div>
                            <div style="color: #aaa; font-size: 0.65rem; line-height: 1.1;">Entregas/Hora<br>Productividad de entregas</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(33, 150, 243, 0.3); border-radius: 4px; padding: 5px; text-align: center; display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 1.4rem; margin-bottom: 4px;">üìä</div>
                            <div style="color: #e8e8e8; font-size: 1rem; font-weight: bold; margin-bottom: 2px;">${formatDecimal(data.kpis.ventas_por_hora)}</div>
                            <div style="color: #aaa; font-size: 0.65rem; line-height: 1.1;">Ventas/Hora<br>Productividad de ventas</div>
                        </div>
                    </div>
                    
                    <!-- M√©tricas de Rendimiento y Tops en grid 2x3 -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 5px; margin-bottom: 5px;">
                        <!-- Fila 1: √öltimos Tickets Escaneados -->
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.5); border-radius: 6px; padding: 8px; overflow: hidden; min-height: 0;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 5px;">
                                <span style="font-size: 1rem;">üé´</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold;">√öLTIMOS TICKETS</span>
                            </div>
                            <div style="color: #aaa; font-size: 0.7rem; line-height: 1.3; max-height: 120px; overflow-y: auto;">
                                ${data.recent_tickets && data.recent_tickets.length > 0 ? data.recent_tickets.map(ticket => `
                                    <div style="display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="color: #667eea; font-weight: bold; font-size: 0.65rem;">${ticket.sale_id}</div>
                                            <div style="color: #888; font-size: 0.6rem;">${ticket.scanned_at}</div>
                                        </div>
                                        <div style="text-align: right; margin-left: 5px;">
                                            <div style="color: #4caf50; font-weight: bold; font-size: 0.65rem;">${ticket.total_items} items</div>
                                            <div style="color: #888; font-size: 0.6rem;">${ticket.caja}</div>
                                        </div>
                                    </div>
                                `).join('') : '<div style="color: #888; padding: 8px; text-align: center; font-size: 0.65rem;">Sin tickets escaneados</div>'}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(33, 150, 243, 0.5); border-radius: 6px; padding: 8px; overflow: hidden; min-height: 0;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 5px;">
                                <span style="font-size: 1rem;">${data.performance.tendencia.direccion === 'up' ? '‚Üë' : data.performance.tendencia.direccion === 'down' ? '‚Üì' : '‚Üí'}</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold;">TENDENCIA</span>
                            </div>
                            <div style="color: #aaa; font-size: 0.7rem; line-height: 1.3;">
                                ${data.performance.tendencia.texto}<br>
                                ${data.performance.tendencia.porcentaje !== 0 ? `${data.performance.tendencia.porcentaje > 0 ? '+' : ''}${formatDecimal(data.performance.tendencia.porcentaje)}%` : 'Sin datos suficientes'}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(255, 193, 7, 0.5); border-radius: 6px; padding: 8px; overflow: hidden; min-height: 0;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 5px;">
                                <span style="font-size: 1rem;">‚ö°</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold;">VELOCIDAD</span>
                            </div>
                            <div style="color: #aaa; font-size: 0.7rem; line-height: 1.3;">
                                <span style="color: #e8e8e8; font-weight: bold;">${data.performance.velocidad.entregas_15min}</span> entregas (√∫ltimos 15 min)<br>
                                Promedio: ${formatDecimal(data.performance.velocidad.promedio_15min)}
                                ${data.performance.velocidad.entregas_15min < data.performance.velocidad.promedio_15min ? '‚ö†Ô∏è' : ''}
                            </div>
                        </div>
                        <!-- Fila 2: Top Cards -->
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 8px; min-height: 0; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 5px;">
                                <span style="font-size: 1rem;">üî•</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold;">Top Productos (Ahora)</span>
                            </div>
                            <div style="color: #aaa; font-size: 0.7rem;">
                                ${data.tops.productos.length > 0 ? data.tops.productos.map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                                        <span style="color: #e8e8e8;">${item.name}</span>
                                        <span style="color: #4caf50; font-weight: bold;">${item.qty}</span>
                                    </div>
                                `).join('') : '<div style="color: #888; padding: 8px; text-align: center; font-size: 0.65rem;">Sin entregas en √∫ltimos 30 min</div>'}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 8px; min-height: 0; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 5px;">
                                <span style="font-size: 1rem;">üë•</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold;">Top Bartenders (Ahora)</span>
                            </div>
                            <div style="color: #aaa; font-size: 0.7rem;">
                                ${data.tops.bartenders.length > 0 ? data.tops.bartenders.map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(102, 126, 234, 0.2);">
                                        <span style="color: #e8e8e8;">${item.name}</span>
                                        <span style="color: #4caf50; font-weight: bold;">${item.qty}</span>
                                    </div>
                                `).join('') : '<div style="color: #888; padding: 8px; text-align: center; font-size: 0.65rem;">Sin entregas en √∫ltimos 30 min</div>'}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; padding: 8px; min-height: 0; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 5px;">
                                <span style="font-size: 1rem;">üìç</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold;">Barra M√°s Activa</span>
                            </div>
                            <div style="color: #aaa; font-size: 0.7rem;">
                                ${data.tops.barra_activa ? `
                                    <div style="text-align: center; padding: 8px;">
                                        <div style="font-size: 1.2rem; color: #e8e8e8; font-weight: bold; margin-bottom: 4px;">${data.tops.barra_activa.qty}</div>
                                        <div style="color: #aaa; font-size: 0.7rem;">${data.tops.barra_activa.name}</div>
                                    </div>
                                ` : '<div style="color: #888; padding: 8px; text-align: center; font-size: 0.65rem;">Sin datos</div>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer del Turno -->
                    <div class="dashboard-footer-full">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div>
                                <span style="color: #aaa; font-size: 0.7rem;">Turno Abierto</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold; margin-left: 10px;">${data.shift.tiempo_transcurrido}</span>
                            </div>
                            <div>
                                <span style="color: #aaa; font-size: 0.7rem;">Entregas:</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold; margin-left: 10px;">${data.shift.total_entregas}</span>
                            </div>
                            <div>
                                <span style="color: #aaa; font-size: 0.7rem;">Entradas:</span>
                                <span style="color: #e8e8e8; font-size: 0.75rem; font-weight: bold; margin-left: 10px;">${data.shift.total_entradas}</span>
                            </div>
                        </div>
                        <div style="color: #aaa; font-size: 0.7rem;">
                            Sistema BIMBA - <span id="current-time-admin">${new Date().toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                        </div>
                    </div>
                    </div>
                </div>
            `;
            
            const dashboardContainer = document.getElementById('stats-dashboard');
            dashboardContainer.innerHTML = html;
            
            // Asegurar que el contenedor use todo el espacio disponible
            dashboardContainer.style.display = 'flex';
            dashboardContainer.style.flexDirection = 'column';
            dashboardContainer.style.height = '100%';
            dashboardContainer.style.overflow = 'hidden';
            
            // Actualizar hora actual
            function updateTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const timeElement = document.getElementById('current-time-admin');
                if (timeElement) {
                    timeElement.textContent = timeStr;
                }
            }
            updateTime();
            setInterval(updateTime, 1000);
        })
        .catch(error => {
            console.error('Error al cargar estad√≠sticas:', error);
            document.getElementById('stats-dashboard').innerHTML = `
                <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 15px; border: 2px solid rgba(244, 67, 54, 0.3);">
                    <h3 style="color: #f44336; margin-bottom: 10px;">‚ö†Ô∏è Error</h3>
                    <p style="color: #aaa;">No se pudieron cargar las estad√≠sticas. Intenta recargar la p√°gina.</p>
                </div>
            `;
        });
}

// Cargar dashboard al inicio
updateStatsDashboard();

// Actualizar cada 5 segundos
dashboardUpdateInterval = setInterval(updateStatsDashboard, 5000);

// Limpiar intervalo al salir de la p√°gina
window.addEventListener('beforeunload', () => {
    if (dashboardUpdateInterval) {
        clearInterval(dashboardUpdateInterval);
    }
});

// Funci√≥n para actualizar estado de servicios
function refreshServicesStatus() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Actualizando...';
    btn.disabled = true;
    
    // Llamar a la API para obtener el estado actualizado
    fetch('/api/services/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                updateServicesStatus(data.services);
                btn.innerHTML = '‚úÖ Actualizado';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } else {
                console.error('Error al obtener estado:', data.message);
                btn.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.innerHTML = '‚ùå Error';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        });
}

// Funci√≥n para actualizar el estado de los servicios en la UI
function updateServicesStatus(services) {
    // Actualizar API (los otros servicios se eliminaron del panel)
    if (services.api) {
        updateServiceCard('api', services.api);
    }
}

// Funci√≥n para actualizar una tarjeta de servicio
function updateServiceCard(serviceName, serviceData) {
    const card = document.querySelector(`[data-service="${serviceName}"]`);
    if (!card) {
        console.warn(`Tarjeta no encontrada para servicio: ${serviceName}`);
        return;
    }
    
    // Determinar si est√° activo (running para servicios del sistema, online para API)
    const isRunning = serviceData.running !== undefined ? serviceData.running : (serviceData.online !== undefined ? serviceData.online : false);
    
    // Buscar elementos dentro de la tarjeta
    const statusParagraph = card.querySelector('p');
    const statusSpan = statusParagraph ? statusParagraph.querySelector('span') : null;
    const messageParagraph = statusParagraph ? statusParagraph.nextElementSibling : null;
    
    // Actualizar color del borde
    if (isRunning) {
        card.style.borderColor = 'rgba(76, 175, 80, 0.5)';
        if (statusSpan) {
            statusSpan.style.color = '#4caf50';
            // Texto diferente para API vs servicios del sistema
            if (serviceName === 'api') {
                statusSpan.textContent = '‚úÖ Conectada';
            } else {
                statusSpan.textContent = '‚úÖ Activo';
            }
        }
    } else {
        card.style.borderColor = 'rgba(244, 67, 54, 0.5)';
        if (statusSpan) {
            statusSpan.style.color = '#f44336';
            // Texto diferente para API vs servicios del sistema
            if (serviceName === 'api') {
                statusSpan.textContent = '‚ùå Desconectada';
            } else {
                statusSpan.textContent = '‚ùå Inactivo';
            }
        }
    }
    
    // Actualizar mensaje
    if (messageParagraph && serviceData.message) {
        // Para API, mostrar tiempo de respuesta si est√° online
        if (serviceName === 'api' && serviceData.online && serviceData.response_time_ms !== undefined) {
            messageParagraph.textContent = `Tiempo de respuesta: ${Math.round(serviceData.response_time_ms)}ms`;
        } else {
            messageParagraph.textContent = serviceData.message || 'Estado desconocido';
        }
    }
    
    // Actualizar fecha de √∫ltima actualizaci√≥n
    const lastUpdatedSpan = card.querySelector(`.last-updated[data-service="${serviceName}"]`);
    if (lastUpdatedSpan && serviceData.last_updated) {
        const date = new Date(serviceData.last_updated);
        const formattedDate = date.toLocaleString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        lastUpdatedSpan.textContent = formattedDate;
    }
    
    // Actualizar badge si existe
    const badge = card.querySelector('.badge');
    if (badge) {
        if (serviceName === 'api') {
            if (isRunning) {
                badge.textContent = 'Online';
                badge.style.background = 'rgba(76, 175, 80, 0.3)';
                badge.style.color = '#4caf50';
            } else {
                badge.textContent = 'Offline';
                badge.style.background = 'rgba(244, 67, 54, 0.3)';
                badge.style.color = '#f44336';
            }
        }
    }
    
    // Mostrar/ocultar bot√≥n de reinicio (solo para servicios del sistema, no API)
    if (serviceName !== 'api') {
        let restartButton = card.querySelector('.btn-restart-service');
        if (!isRunning) {
            // Servicio ca√≠do: mostrar bot√≥n de reinicio si no existe
            if (!restartButton) {
                const buttonDiv = document.createElement('div');
                buttonDiv.style.marginTop = '15px';
                buttonDiv.innerHTML = `
                    <button onclick="restartService('${serviceName}')" class="btn-restart-service" style="padding: 8px 16px; background: rgba(255, 152, 0, 0.2); border: 1px solid rgba(255, 152, 0, 0.5); color: #ff9800; border-radius: 5px; cursor: pointer; font-size: 0.9rem; width: 100%;">
                        üîÑ Reiniciar Servicio
                    </button>
                `;
                card.appendChild(buttonDiv);
            }
        } else {
            // Servicio activo: ocultar bot√≥n de reinicio si existe
            if (restartButton) {
                restartButton.parentElement.remove();
            }
        }
    }
    
    console.log(`Servicio ${serviceName} actualizado:`, { isRunning, status: serviceData.status || serviceData.online });
}

// Funciones de notificaci√≥n (si no existen)
if (typeof showLoading === 'undefined') {
    window.showLoading = function(message) {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-overlay';
        loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem;';
        loadingDiv.innerHTML = `<div style="text-align: center;"><div style="margin-bottom: 10px;">‚è≥</div><div>${message || 'Cargando...'}</div></div>`;
        document.body.appendChild(loadingDiv);
    };
}

if (typeof hideLoading === 'undefined') {
    window.hideLoading = function() {
        const loadingDiv = document.getElementById('loading-overlay');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    };
}

if (typeof showSuccess === 'undefined') {
    window.showSuccess = function(message) {
        alert(message);
    };
}

if (typeof showError === 'undefined') {
    window.showError = function(message) {
        alert(message);
    };
}

// Funci√≥n para reiniciar un servicio (eliminada - ya no se monitorean servicios del sistema)

// Verificar estado solo al abrir el turno (no autom√°ticamente)
// La verificaci√≥n se hace solo cuando se abre un turno


</script>
{% endblock %}

