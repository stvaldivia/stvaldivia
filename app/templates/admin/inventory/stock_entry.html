{% extends "base.html" %}
{% block title %}üì• Ingresar Compra/Stock - BIMBA{% endblock %}

{% block head_extra %}
<style>
    .stock-entry-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-sm, 0.75rem);
        width: 100%;
        box-sizing: border-box;
    }

    @media (min-width: 768px) {
        .stock-entry-container {
            padding: var(--spacing-md, 1rem);
        }
    }

    @media (min-width: 1024px) {
        .stock-entry-container {
            padding: var(--spacing-lg, 1.5rem);
        }
    }

    .header-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: var(--spacing-md, 1rem);
        margin-bottom: var(--spacing-md, 1rem);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    @media (min-width: 768px) {
        .header-section {
            padding: var(--spacing-lg, 1.5rem);
            margin-bottom: var(--spacing-lg, 1.5rem);
        }
    }

    .header-section h1 {
        color: #00ff00;
        margin-bottom: 10px;
        font-size: clamp(1.5rem, 5vw, 2.5rem);
    }

    .form-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: var(--spacing-md, 1rem);
        margin-bottom: var(--spacing-md, 1rem);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    @media (min-width: 768px) {
        .form-section {
            padding: var(--spacing-lg, 1.5rem);
            margin-bottom: var(--spacing-lg, 1.5rem);
        }
    }

    .form-section h2 {
        color: #667eea;
        margin-bottom: var(--spacing-md, 1rem);
        font-size: clamp(1.25rem, 4vw, 1.8rem);
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        padding-bottom: 10px;
    }

    .form-group {
        margin-bottom: var(--spacing-md, 1rem);
        width: 100%;
    }

    .form-group label {
        display: block;
        color: #ccc;
        font-weight: bold;
        margin-bottom: var(--spacing-xs, 0.5rem);
        font-size: var(--font-size-sm, clamp(0.875rem, 2vw, 1rem));
    }

    .form-group select,
    .form-group input {
        width: 100%;
        min-height: 44px;
        padding: var(--spacing-sm, 0.75rem) var(--spacing-md, 1rem);
        background: #2a2a3e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: #fff;
        font-size: var(--font-size-base, clamp(1rem, 2.5vw, 1.125rem));
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
    }

    .ingredients-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-sm, 0.75rem);
        margin-top: var(--spacing-md, 1rem);
    }

    @media (min-width: 480px) {
        .ingredients-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 768px) {
        .ingredients-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-md, 1rem);
        }
    }

    .ingredient-card {
        background: #2a2a3e;
        border: 2px solid rgba(102, 126, 234, 0.2);
        border-radius: 10px;
        padding: var(--spacing-md, 1rem);
        transition: all 0.3s;
        width: 100%;
        box-sizing: border-box;
    }

    @media (min-width: 768px) {
        .ingredient-card {
            padding: var(--spacing-lg, 1.5rem);
        }
    }

    .ingredient-card:hover {
        border-color: rgba(102, 126, 234, 0.5);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .ingredient-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .ingredient-name {
        color: #fff;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .ingredient-unit {
        color: #aaa;
        font-size: 0.9rem;
    }

    .ingredient-input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
    }

    .ingredient-input-group input {
        padding: var(--spacing-sm, 0.75rem);
        min-height: 44px;
        background: #1a1a2e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 6px;
        color: #fff;
        font-size: var(--font-size-base, clamp(1rem, 2.5vw, 1.125rem));
        width: 100%;
        box-sizing: border-box;
    }

    .btn {
        padding: var(--spacing-sm, 0.75rem) var(--spacing-md, 1rem);
        min-height: 44px;
        border: none;
        border-radius: 8px;
        font-size: var(--font-size-base, clamp(1rem, 2.5vw, 1.125rem));
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }

    @media (min-width: 768px) {
        .btn {
            width: auto;
            padding: var(--spacing-sm, 0.75rem) var(--spacing-lg, 1.5rem);
        }
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #2a2a3e;
        color: #ccc;
        border: 2px solid rgba(102, 126, 234, 0.3);
    }

    .btn-secondary:hover {
        background: #3a3a4e;
        color: white;
    }

    .form-actions {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm, 0.75rem);
        margin-top: var(--spacing-lg, 1.5rem);
        width: 100%;
    }

    @media (min-width: 768px) {
        .form-actions {
            flex-direction: row;
            justify-content: flex-end;
        }
    }

    .category-section {
        margin-bottom: 30px;
    }

    .category-header {
        color: #667eea;
        font-size: 1.5rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    }

    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .alert-success {
        background: rgba(0, 255, 0, 0.1);
        border: 1px solid rgba(0, 255, 0, 0.3);
        color: #00ff00;
    }

    .alert-error {
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid rgba(255, 68, 68, 0.3);
        color: #ff4444;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #aaa;
    }

    .loading.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="stock-entry-container">
    <div class="header-section">
        <h1>üì• Ingresar Compra/Stock</h1>
        <p style="color: #aaa;">Registra entradas de stock de ingredientes (compras, reposiciones, etc.)</p>
        
        <div style="margin-top: 20px;">
            <a href="{{ url_for('inventory_admin.dashboard') }}" class="btn btn-secondary">
                ‚Üê Volver al Dashboard
            </a>
        </div>
    </div>

    <div id="alert-container"></div>

    <form id="stock-entry-form">
        <div class="form-section">
            <h2>üìã Informaci√≥n General</h2>
            
            <div class="form-group">
                <label for="ubicacion">üìç Ubicaci√≥n <span style="color: #ff4444;">*</span></label>
                <select id="ubicacion" name="ubicacion" required>
                    <option value="">Selecciona una ubicaci√≥n</option>
                    {% for ubicacion in ubicaciones %}
                    <option value="{{ ubicacion }}">{{ ubicacion }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="reason">üìù Motivo/Notas</label>
                <input type="text" id="reason" name="reason" placeholder="Ej: Compra proveedor, Reposici√≥n, Transferencia, etc.">
            </div>
        </div>

        <div class="form-section">
            <h2>ü•§ Ingredientes</h2>
            <p style="color: #aaa; margin-bottom: 20px;">Ingresa las cantidades de cada ingrediente que est√°s agregando al inventario.</p>
            
            {% if ingredientes_por_categoria %}
                {% for categoria, ingredientes in ingredientes_por_categoria.items() %}
                <div class="category-section">
                    <h3 class="category-header">{{ categoria }}</h3>
                    <div class="ingredients-grid">
                        {% for ingrediente in ingredientes %}
                        <div class="ingredient-card">
                            <div class="ingredient-header">
                                <span class="ingredient-name">{{ ingrediente.name }}</span>
                                <span class="ingredient-unit">{{ ingrediente.base_unit }}</span>
                            </div>
                            <div class="ingredient-input-group">
                                <input 
                                    type="number" 
                                    step="0.001" 
                                    min="0" 
                                    placeholder="0" 
                                    class="ingredient-quantity-input"
                                    data-ingredient-id="{{ ingrediente.id }}"
                                    data-ingredient-name="{{ ingrediente.name }}"
                                    data-ingredient-unit="{{ ingrediente.base_unit }}"
                                >
                                <span style="color: #aaa; font-size: 0.9rem;">{{ ingrediente.base_unit }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 40px; color: #aaa;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">ü•§</div>
                    <p>No hay ingredientes activos. Crea ingredientes primero.</p>
                    <a href="{{ url_for('ingredients.create_ingredient') }}" class="btn btn-primary" style="margin-top: 20px;">
                        ‚ûï Crear Ingrediente
                    </a>
                </div>
            {% endif %}
        </div>

        {% if ingredientes_por_categoria %}
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url_for('inventory_admin.dashboard') }}'">
                Cancelar
            </button>
            <button type="submit" class="btn btn-primary">
                üíæ Registrar Entrada de Stock
            </button>
        </div>
        {% endif %}
    </form>

    <div id="loading" class="loading">
        <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
        <p>Procesando entrada de stock...</p>
    </div>
</div>

<script>
document.getElementById('stock-entry-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const ubicacion = document.getElementById('ubicacion').value;
    const reason = document.getElementById('reason').value;
    
    if (!ubicacion) {
        showAlert('Por favor selecciona una ubicaci√≥n', 'error');
        return;
    }
    
    // Recopilar ingredientes con cantidad > 0
    const entries = [];
    const inputs = document.querySelectorAll('.ingredient-quantity-input');
    
    inputs.forEach(input => {
        const quantity = parseFloat(input.value);
        if (quantity > 0) {
            entries.push({
                ingredient_id: parseInt(input.dataset.ingredientId),
                ingredient_name: input.dataset.ingredientName,
                quantity: quantity,
                unit: input.dataset.ingredientUnit
            });
        }
    });
    
    if (entries.length === 0) {
        showAlert('Por favor ingresa al menos una cantidad mayor a 0', 'error');
        return;
    }
    
    // Mostrar loading
    document.getElementById('loading').classList.add('active');
    document.getElementById('stock-entry-form').style.opacity = '0.5';
    document.getElementById('stock-entry-form').style.pointerEvents = 'none';
    
    try {
        // Procesar cada entrada
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const entry of entries) {
            try {
                const response = await fetch('/admin/inventario/api/add-stock-entry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingredient_id: entry.ingredient_id,
                        ubicacion: ubicacion,
                        quantity: entry.quantity,
                        reason: reason || `Entrada manual: ${entry.ingredient_name}`
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successCount++;
                    // Limpiar input
                    const input = document.querySelector(`[data-ingredient-id="${entry.ingredient_id}"]`);
                    if (input) input.value = '';
                } else {
                    errorCount++;
                    errors.push(`${entry.ingredient_name}: ${data.error}`);
                }
            } catch (error) {
                errorCount++;
                errors.push(`${entry.ingredient_name}: ${error.message}`);
            }
        }
        
        // Ocultar loading
        document.getElementById('loading').classList.remove('active');
        document.getElementById('stock-entry-form').style.opacity = '1';
        document.getElementById('stock-entry-form').style.pointerEvents = 'auto';
        
        // Mostrar resultado
        if (errorCount === 0) {
            showAlert(`‚úÖ ${successCount} entrada(s) de stock registrada(s) exitosamente`, 'success');
            document.getElementById('stock-entry-form').reset();
        } else {
            showAlert(
                `‚ö†Ô∏è ${successCount} entrada(s) exitosa(s), ${errorCount} error(es):\n${errors.join('\n')}`,
                'error'
            );
        }
        
    } catch (error) {
        document.getElementById('loading').classList.remove('active');
        document.getElementById('stock-entry-form').style.opacity = '1';
        document.getElementById('stock-entry-form').style.pointerEvents = 'auto';
        showAlert('Error al procesar entrada de stock: ' + error.message, 'error');
    }
});

function showAlert(message, type) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alert.style.whiteSpace = 'pre-line';
    container.innerHTML = '';
    container.appendChild(alert);
    
    // Auto-ocultar despu√©s de 5 segundos
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}

