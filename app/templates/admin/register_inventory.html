{% extends "base.html" %}
{% block title %}Registrar Inventario Inicial - Control de Stock BIMBA{% endblock %}
{% block meta_description %}Registro del inventario inicial de ingredientes y productos. Configuraci√≥n de stock base para el control de consumo en el sistema BIMBA.{% endblock %}

{% block head_extra %}
<style>
    .inventory-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .form-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .form-card h2 {
        color: #00ff00;
        margin-bottom: 20px;
        font-size: 2rem;
        text-align: center;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        color: #ccc;
        margin-bottom: 10px;
        font-size: 1.1rem;
        font-weight: bold;
    }

    .form-group select {
        width: 100%;
        padding: 12px;
        background: #2a2a3e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .form-group select:focus {
        outline: none;
        border-color: #667eea;
    }

    .products-section {
        margin-top: 30px;
    }

    .product-item {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
        padding: 15px;
        background: #2a2a3e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
    }

    .product-item input[type="text"] {
        padding: 12px;
        background: #1a1a2e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .product-item input[type="number"] {
        padding: 12px;
        background: #1a1a2e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
        box-sizing: border-box;
        width: 100%;
    }

    .product-item input:focus {
        outline: none;
        border-color: #667eea;
    }

    .btn-add-product {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 10px;
    }

    .btn-add-product:hover {
        background: #5568d3;
    }

    .btn-remove-product {
        background: #ff4444;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .btn-remove-product:hover {
        background: #cc3333;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }

    .btn {
        padding: 15px 40px;
        border: none;
        border-radius: 10px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #444;
        color: #e8e8e8;
    }

    .btn-secondary:hover {
        background: #555;
    }

    .info-box {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.5);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #ccc;
    }

    .registered-barras {
        margin-top: 20px;
        padding: 15px;
        background: rgba(0, 255, 0, 0.1);
        border: 1px solid rgba(0, 255, 0, 0.3);
        border-radius: 8px;
    }

    .registered-barras h3 {
        color: #00ff00;
        margin-bottom: 10px;
    }

    .registered-barras ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .registered-barras li {
        color: #ccc;
        padding: 5px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="inventory-container">
    <div class="form-card">
        <h2>üì¶ Registrar Inventario Inicial</h2>
        <p style="text-align: center; color: #aaa; margin-bottom: 30px;">
            Ingresa la cantidad inicial de botellas por barra al abrir el turno.
        </p>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Instrucciones:</strong><br>
            ‚Ä¢ Selecciona la barra<br>
            ‚Ä¢ Ingresa el nombre del producto y la cantidad inicial<br>
            ‚Ä¢ El sistema rastrear√° autom√°ticamente las entregas<br>
            ‚Ä¢ Al cerrar el turno, calcular√° cu√°ntas botellas deber√≠an quedar
        </div>

        {% if current_inventory %}
        <div class="registered-barras">
            <h3>‚úÖ Inventarios ya registrados:</h3>
            <ul>
                {% for barra, summary in current_inventory.items() %}
                <li>üìä {{ barra }}: {{ summary.total_items }} productos</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <form method="POST" action="{{ url_for('routes.register_inventory') }}" id="inventoryForm">
            <!-- Selecci√≥n de Barra -->
            <div class="form-group">
                <label for="barra">
                    Barra <span style="color: #ff4444;">*</span>
                </label>
                <select id="barra" name="barra" required>
                    <option value="">Selecciona una barra</option>
                    {% for barra in barras_disponibles %}
                    <option value="{{ barra }}">{{ barra }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Productos -->
            <div class="products-section">
                <h3 style="color: #ccc; margin-bottom: 20px;">Productos</h3>
                <div id="products-container">
                    <div class="product-item">
                        <input type="text" name="product_1" placeholder="Ej: Botella Vodka, Botella Ron, etc." required
                            class="product-name-input" list="products-list">
                        <input type="number" name="qty_1" placeholder="Cantidad" min="0" required
                            class="product-qty-input">
                    </div>
                </div>

                <datalist id="products-list">
                    {% for product in all_products %}
                    <option value="{{ product.name }}">
                        {% endfor %}
                </datalist>

                <button type="button" class="btn-add-product" onclick="addProduct()">
                    + Agregar Producto
                </button>
            </div>

            <!-- Botones -->
            <div class="form-actions">
                <a href="{{ url_for('routes.view_inventory') }}" class="btn btn-secondary">
                    Ver Inventario
                </a>
                <button type="submit" class="btn btn-primary">
                    üíæ Registrar Inventario
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let productCount = 1;

    function addProduct() {
        productCount++;
        const container = document.getElementById('products-container');
        const productDiv = document.createElement('div');
        productDiv.className = 'product-item';
        productDiv.innerHTML = `
        <input
            type="text"
            name="product_${productCount}"
            placeholder="Ej: Botella Vodka, Ron, Jarabe, etc."
            required
            class="product-name-input"
            list="products-list"
        >
        <div style="display: flex; gap: 10px;">
            <input
                type="number"
                name="qty_${productCount}"
                placeholder="Cantidad"
                min="0"
                required
                style="flex: 1;"
                class="product-qty-input"
            >
            <button type="button" class="btn-remove-product" onclick="removeProduct(this)">
                ‚úï
            </button>
        </div>
    `;
        container.appendChild(productDiv);
    }

    function removeProduct(button) {
        if (document.querySelectorAll('.product-item').length > 1) {
            button.closest('.product-item').remove();
        } else {
            showError('Debe haber al menos un producto');
        }
    }

    // Validaci√≥n y conversi√≥n de nombres de productos al formato esperado
    document.getElementById('inventoryForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const barra = document.getElementById('barra').value;
        const productNameInputs = document.querySelectorAll('.product-name-input');
        const productQtyInputs = document.querySelectorAll('.product-qty-input');

        // Validar barra seleccionada
        if (!barra) {
            showError('Debes seleccionar una barra');
            document.getElementById('barra').focus();
            return;
        }

        // Validar que haya al menos un producto v√°lido
        let validProducts = 0;
        const errors = [];

        productNameInputs.forEach((nameInput, index) => {
            const productName = nameInput.value.trim();
            const quantityInput = productQtyInputs[index];
            const quantity = parseInt(quantityInput?.value) || 0;

            // Validar nombre de producto
            if (productName && quantity > 0) {
                validProducts++;
            } else if (productName && quantity <= 0) {
                errors.push(`"${productName}" tiene cantidad inv√°lida (debe ser mayor a 0)`);
                quantityInput?.focus();
            } else if (!productName && quantity > 0) {
                errors.push(`El producto #${index + 1} necesita un nombre`);
                nameInput.focus();
            }
        });

        if (validProducts === 0) {
            showError('Debes ingresar al menos un producto con cantidad mayor a 0');
            return;
        }

        if (errors.length > 0) {
            showError(errors.join('<br>'));
            return;
        }

        // Mostrar loading
        showLoading('Registrando inventario...');

        // Crear FormData y convertir al formato esperado
        const formData = new FormData();
        formData.append('barra', barra);

        productNameInputs.forEach((nameInput, index) => {
            const productName = nameInput.value.trim();
            const quantityInput = productQtyInputs[index];
            const quantity = quantityInput?.value;

            if (productName && quantity) {
                // Formato esperado: product_name_<index> y quantity_<index>
                formData.append(`product_name_${index + 1}`, productName);
                formData.append(`quantity_${index + 1}`, quantity);
            }
        });

        try {
            const response = await fetch('{{ url_for("routes.register_inventory") }}', {
                method: 'POST',
                body: formData
            });

            hideLoading();

            if (response.ok) {
                showSuccess('‚úÖ Inventario registrado correctamente');
                setTimeout(() => {
                    window.location.href = '{{ url_for("routes.view_inventory") }}';
                }, 1500);
            } else {
                const text = await response.text();
                try {
                    const data = JSON.parse(text);
                    showError(data.message || 'Error al registrar inventario');
                } catch {
                    showError('Error al registrar inventario. Por favor, intenta nuevamente.');
                }
            }
        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showError('Error de conexi√≥n. Por favor, verifica tu conexi√≥n e intenta nuevamente.');
        }
    });
</script>
{% endblock %}