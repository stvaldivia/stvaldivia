{% extends "base.html" %}
{% block title %}Inventario del Turno{% endblock %}

{% block head_extra %}
<style>
    .inventory-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .header-section {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .header-section h1 {
        color: #00ff00;
        margin-bottom: 10px;
        font-size: 2.5rem;
    }

    .header-section p {
        color: #aaa;
        font-size: 1.1rem;
    }

    .bar-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .bar-card h2 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.8rem;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        padding-bottom: 10px;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-box {
        background: #2a2a3e;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }

    .stat-box .label {
        color: #aaa;
        font-size: 0.9rem;
        margin-bottom: 10px;
    }

    .stat-box .value {
        color: #fff;
        font-size: 2rem;
        font-weight: bold;
    }

    .stat-box.positive .value {
        color: #00ff00;
    }

    .stat-box.negative .value {
        color: #ff4444;
    }

    .stat-box.warning .value {
        color: #ffaa00;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .items-table th {
        background: #2a2a3e;
        color: #667eea;
        padding: 15px;
        text-align: left;
        border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        font-weight: bold;
    }

    .items-table td {
        padding: 15px;
        border-bottom: 1px solid rgba(102, 126, 234, 0.2);
        color: #ccc;
    }

    .items-table tr:hover {
        background: rgba(102, 126, 234, 0.1);
    }

    .items-table .number {
        text-align: right;
        font-weight: bold;
    }

    .no-inventory {
        text-align: center;
        padding: 40px;
        color: #aaa;
    }

    .no-inventory h3 {
        color: #667eea;
        margin-bottom: 15px;
    }

    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
        background: #00ff00;
        color: #000;
    }

    .btn-success:hover {
        background: #00cc00;
    }

    .actions-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.85rem;
        font-weight: bold;
    }

    .badge-success {
        background: rgba(0, 255, 0, 0.2);
        color: #00ff00;
        border: 1px solid rgba(0, 255, 0, 0.3);
    }

    .badge-warning {
        background: rgba(255, 170, 0, 0.2);
        color: #ffaa00;
        border: 1px solid rgba(255, 170, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="inventory-container">
    <div class="header-section">
        <h1>üì¶ Inventario del Turno</h1>
        <p>Fecha: {{ shift_date }}</p>
        <div class="actions-bar">
            <a href="{{ url_for('routes.register_inventory') }}" class="btn btn-primary">
                ‚ûï Registrar Inventario Inicial
            </a>
            <a href="{{ url_for('routes.admin_dashboard') }}" class="btn" style="background: #444; color: #e8e8e8;">
                ‚Üê Volver al Dashboard
            </a>
        </div>
    </div>

    {% if inventory_summary %}
        {% for barra, summary in inventory_summary.items() %}
        <div class="bar-card">
            <h2>
                üç∫ {{ barra }}
                {% if summary.is_finalized %}
                <span class="badge badge-success">Finalizado</span>
                {% else %}
                <span class="badge badge-warning">En Progreso</span>
                {% endif %}
            </h2>

            <div class="summary-stats">
                <div class="stat-box">
                    <div class="label">Productos</div>
                    <div class="value">{{ summary.total_items }}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Inicial</div>
                    <div class="value">{{ summary.total_initial }}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Entregadas</div>
                    <div class="value">{{ summary.total_delivered }}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Esperadas Final</div>
                    <div class="value">{{ summary.total_expected_final }}</div>
                </div>
                {% if summary.total_actual_final is not none %}
                <div class="stat-box">
                    <div class="label">Reales Final</div>
                    <div class="value">{{ summary.total_actual_final }}</div>
                </div>
                <div class="stat-box {% if summary.total_difference < 0 %}negative{% elif summary.total_difference > 0 %}positive{% endif %}">
                    <div class="label">Diferencia</div>
                    <div class="value">
                        {% if summary.total_difference > 0 %}+{% endif %}{{ summary.total_difference }}
                    </div>
                </div>
                {% endif %}
            </div>

            {% if summary.items %}
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th class="number">Inicial</th>
                        <th class="number">Entregadas</th>
                        <th class="number">Esperadas Final</th>
                        {% if summary.is_finalized %}
                        <th class="number">Reales Final</th>
                        <th class="number">Diferencia</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for item in summary.items %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td class="number">{{ item.initial_quantity }}</td>
                        <td class="number">{{ item.delivered_quantity }}</td>
                        <td class="number">{{ item.expected_final }}</td>
                        {% if summary.is_finalized %}
                        <td class="number">
                            {% if item.final_quantity is not none %}
                                {{ item.final_quantity }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="number {% if item.difference < 0 %}negative{% elif item.difference > 0 %}positive{% endif %}">
                            {% if item.difference > 0 %}+{% endif %}{{ item.difference }}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}

            {% if not summary.is_finalized %}
            <div style="margin-top: 20px;">
                <button 
                    type="button" 
                    class="btn btn-success" 
                    onclick="finalizeInventory('{{ barra }}')"
                >
                    ‚úÖ Finalizar Inventario
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="bar-card">
            <div class="no-inventory">
                <h3>üì≠ No hay inventario registrado</h3>
                <p>Registra el inventario inicial de las barras para comenzar el seguimiento.</p>
                <a href="{{ url_for('routes.register_inventory') }}" class="btn btn-primary" style="margin-top: 20px;">
                    Registrar Inventario Inicial
                </a>
            </div>
        </div>
    {% endif %}
</div>

<script>
function finalizeInventory(barra) {
    if (!confirm(`¬øFinalizar el inventario de ${barra}? Esto calcular√° las cantidades finales esperadas.`)) {
        return;
    }

    // Mostrar loading
    showLoading('Finalizando inventario...');

    fetch('{{ url_for("routes.finalize_inventory") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `barra=${encodeURIComponent(barra)}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.text().then(text => {
            try {
                return JSON.parse(text);
            } catch {
                // Si no es JSON, puede ser un redirect o HTML
                throw new Error('Respuesta inv√°lida del servidor');
            }
        });
    })
    .then(data => {
        hideLoading();
        if (data.status === 'success' || (data.flash && data.flash.includes('success'))) {
            showSuccess('‚úÖ Inventario finalizado correctamente');
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            const message = data.message || data.flash || 'Error al finalizar inventario';
            showError('‚ùå ' + message);
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error:', error);
        showError('‚ùå Error al finalizar inventario: ' + error.message);
    });
}
</script>
{% endblock %}


