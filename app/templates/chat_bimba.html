{% extends "base.html" %}
{% block title %}Habla con BIMBA - Agente de IA{% endblock %}
{% block meta_description %}Chatea con BIMBA, el agente de inteligencia artificial de Club BIMBA. Obt√©n informaci√≥n sobre eventos, horarios, precios y m√°s.{% endblock %}

{% block head_extra %}
<style>
    .chat-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 20px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border-radius: 20px;
        border: 2px solid rgba(236, 72, 153, 0.3);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .chat-header {
        text-align: center;
        padding: 20px;
        border-bottom: 2px solid rgba(236, 72, 153, 0.2);
        margin-bottom: 20px;
    }
    
    .chat-header h1 {
        color: #e8e8e8;
        font-size: 2rem;
        margin: 0 0 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }
    
    .chat-header p {
        color: #cbd5e1;
        margin: 0;
        font-size: 0.95rem;
    }
    
    .chat-messages {
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        margin-bottom: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .message {
        display: flex;
        gap: 12px;
        max-width: 80%;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }
    
    .message.bot {
        align-self: flex-start;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .message.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .message.bot .message-avatar {
        background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
    }
    
    .message-content {
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        line-height: 1.5;
    }
    
    .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.bot .message-content {
        background: rgba(236, 72, 153, 0.2);
        color: #e8e8e8;
        border: 1px solid rgba(236, 72, 153, 0.3);
        border-bottom-left-radius: 4px;
    }
    
    .chat-input-container {
        display: flex;
        gap: 10px;
    }
    
    .chat-input {
        flex: 1;
        padding: 15px 20px;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(236, 72, 153, 0.3);
        border-radius: 25px;
        color: #e8e8e8;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s ease;
    }
    
    .chat-input:focus {
        border-color: rgba(236, 72, 153, 0.6);
    }
    
    .chat-input::placeholder {
        color: #94a3b8;
    }
    
    .send-button {
        padding: 15px 30px;
        background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
        border: none;
        border-radius: 25px;
        color: white;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 20px rgba(236, 72, 153, 0.4);
    }
    
    .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .loading-indicator {
        display: none;
        padding: 12px 16px;
        background: rgba(236, 72, 153, 0.2);
        border: 1px solid rgba(236, 72, 153, 0.3);
        border-radius: 18px;
        color: #e8e8e8;
        align-self: flex-start;
    }
    
    .loading-indicator.active {
        display: block;
    }
    
    .loading-dots {
        display: inline-block;
    }
    
    .loading-dots::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    
    .error-message {
        padding: 12px 16px;
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 18px;
        color: #fca5a5;
        align-self: flex-start;
    }
    
    @media (max-width: 768px) {
        .chat-container {
            margin: 20px;
            padding: 15px;
        }
        
        .chat-messages {
            height: 400px;
        }
        
        .message {
            max-width: 90%;
        }
        
        .chat-header h1 {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h1>
            <span>ü§ñ</span>
            <span>¬°Habla con BIMBA!</span>
        </h1>
        <p>Tu agente de IA est√° aqu√≠ para ayudarte. Pregunta sobre eventos, horarios, precios y m√°s.</p>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <div class="message bot">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                ¬°Hola! üëã Soy BIMBA, tu agente de inteligencia artificial. Estoy aqu√≠ para ayudarte con cualquier pregunta sobre el club, eventos, horarios, precios y mucho m√°s. ¬øEn qu√© puedo ayudarte? üíú
            </div>
        </div>
    </div>
    
    <div class="chat-input-container">
        <input 
            type="text" 
            class="chat-input" 
            id="messageInput" 
            placeholder="Escribe tu mensaje aqu√≠..."
            autocomplete="off"
        >
        <button class="send-button" id="sendButton" onclick="sendMessage()">
            Enviar
        </button>
    </div>
</div>

<script>
const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');

// Permitir enviar con Enter
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = isUser ? 'üë§' : 'ü§ñ';
    
    const messageContent = document.createElement('div');
    messageContent.className = 'message-content';
    messageContent.textContent = content;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    chatMessages.appendChild(messageDiv);
    
    // Scroll al final
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading-indicator active';
    loadingDiv.id = 'loadingIndicator';
    loadingDiv.innerHTML = '<span class="loading-dots">BIMBA est√° escribiendo</span>';
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideLoading() {
    const loading = document.getElementById('loadingIndicator');
    if (loading) {
        loading.remove();
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    chatMessages.appendChild(errorDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Remover el error despu√©s de 5 segundos
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

async function sendMessage() {
    const message = messageInput.value.trim();
    
    if (!message) {
        return;
    }
    
    // Agregar mensaje del usuario
    addMessage(message, true);
    messageInput.value = '';
    
    // Deshabilitar input y bot√≥n
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    // Mostrar indicador de carga
    showLoading();
    
    try {
        const response = await fetch('/api/v1/bot/responder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                mensaje: message,
                canal: 'web'
            })
        });
        
        const data = await response.json();
        
        hideLoading();
        
        if (response.ok && data.status === 'ok') {
            addMessage(data.respuesta, false);
        } else {
            const errorMsg = data.detalle || data.error || 'Error al obtener respuesta';
            showError(`‚ùå ${errorMsg}`);
        }
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showError('‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.');
    } finally {
        // Habilitar input y bot√≥n
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
    }
}

// Focus en el input al cargar
messageInput.focus();
</script>
{% endblock %}

