{% extends "base.html" %}
{% block title %}Gesti√≥n de Turnos - Admin{% endblock %}

{% block head_extra %}
<style>
    /* Forzar ancho completo para la p√°gina de turnos */
    /* Sobrescribir el max-width del contenedor principal solo en esta p√°gina */
    body .container {
        max-width: 100% !important;
    }
    
    body .main-container {
        max-width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
    }
    
    /* Optimizado para pantalla de 52" - Fuentes y elementos grandes para mejor legibilidad */
    .admin-turnos {
        width: 100%;
        max-width: 100%;
        padding: 30px;
        box-sizing: border-box;
        margin: 0;
    }
    
    .turnos-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 30px;
        margin-bottom: 40px;
        padding: 30px 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        flex-wrap: wrap;
    }
    
    .turnos-header-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 0 0 auto;
        min-width: 250px;
    }
    
    .turnos-header h1 {
        margin: 0;
        font-size: 2.2rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        white-space: nowrap;
        font-weight: bold;
    }
    
    .turnos-header p {
        margin: 0;
        font-size: 1.2rem;
        opacity: 0.9;
        white-space: nowrap;
    }
    
    .turnos-header-right {
        display: flex;
        align-items: center;
        gap: 20px;
        flex: 1;
        min-width: 0;
    }
    
    .turnos-header-right label {
        margin: 0;
        font-size: 1.2rem;
        white-space: nowrap;
        flex-shrink: 0;
        font-weight: 500;
    }
    
    .turnos-header-right select {
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        flex: 1;
        min-width: 0;
        width: 100%;
    }
    
    .turnos-header-right select option {
        background: #667eea;
        color: white;
        font-size: 1rem;
        padding: 10px;
    }
    
    .flujo-container {
        display: flex;
        flex-direction: row;
        gap: 15px;
        flex-wrap: nowrap;
        overflow-x: auto;
    }
    
    .step-card {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 15px;
        padding: 25px;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 300px;
        max-width: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .step-card.completed {
        border-color: rgba(76, 175, 80, 0.5);
        background: linear-gradient(135deg, #1a2e1a 0%, #163e16 100%);
    }
    
    .step-card.active {
        border-color: rgba(102, 126, 234, 0.8);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    
    .step-header {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
        flex-wrap: wrap;
    }
    
    .step-header:hover {
        opacity: 0.9;
    }
    
    .step-number {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .step-card.completed .step-number {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
    }
    
    .step-title {
        font-size: 1.5rem;
        color: #e8e8e8;
        margin: 0;
        flex: 1;
        line-height: 1.4;
        font-weight: 600;
    }
    
    .step-status {
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 1.1rem;
        font-weight: bold;
    }
    
    .step-status.pending {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
    }
    
    .step-status.completed {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
    }
    
    .step-toggle {
        margin-left: 10px;
        color: #aaa;
        font-size: 1.2rem;
        transition: transform 0.3s;
    }
    
    .step-card.collapsed .step-toggle {
        transform: rotate(-90deg);
    }
    
    .step-content {
        margin-top: 15px;
        max-height: 2000px;
        overflow-y: auto;
        overflow-x: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
        opacity: 1;
        flex: 1;
    }
    
    .step-card.collapsed .step-content {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
        overflow: hidden;
    }
    
    .step-summary {
        display: none;
        padding: 15px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        margin-top: 15px;
        color: #aaa;
        font-size: 0.95rem;
    }
    
    .step-card.completed.collapsed .step-summary {
        display: block;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        color: #aaa;
        font-size: 1.1rem;
        margin-bottom: 10px;
        font-weight: 500;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 16px;
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: #e8e8e8;
        font-size: 1.1rem;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: rgba(102, 126, 234, 0.6);
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 32px;
        border: none;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        padding: 16px 32px;
        border: none;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }
    
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .checkbox-item {
        background: rgba(102, 126, 234, 0.1);
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
    }
    
    .checkbox-item:hover {
        background: rgba(102, 126, 234, 0.2);
    }
    
    .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin: 0;
    }
    
    .checkbox-item label {
        flex: 1;
        color: #e8e8e8;
        cursor: pointer;
        margin: 0;
        font-size: 0.95rem;
    }
    
    .checkbox-item .checkbox-info {
        color: #aaa;
        font-size: 0.85rem;
    }
    
    .info-display {
        background: rgba(102, 126, 234, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .info-display label {
        display: block;
        color: #aaa;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .info-display value {
        display: block;
        color: #e8e8e8;
        font-size: 1.1rem;
        font-weight: bold;
    }
    
    .section-title {
        color: #e8e8e8;
        font-size: 1.2rem;
        margin: 20px 0 15px 0;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(102, 126, 234, 0.3);
    }
    
    /* Estilos para la planilla tipo tabla */
    .planilla-table-container {
        margin: 20px 0;
        overflow-x: auto;
    }
    
    .planilla-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(26, 26, 46, 0.95);
        border: 2px solid rgba(102, 126, 234, 0.3);
        font-family: Arial, sans-serif;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .planilla-table thead th {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.8) 0%, rgba(118, 75, 162, 0.8) 100%);
        color: white;
        padding: 12px;
        text-align: center;
        font-weight: bold;
        border-bottom: 2px solid rgba(102, 126, 234, 0.5);
        font-size: 1rem;
    }
    
    .planilla-table tbody td {
        padding: 10px;
        border: 1px solid rgba(102, 126, 234, 0.2);
        text-align: left;
        background: rgba(26, 26, 46, 0.7);
        color: #e8e8e8;
    }
    
    .planilla-table tbody tr:nth-child(even) td {
        background: rgba(102, 126, 234, 0.05);
    }
    
    .planilla-table tbody tr:hover td {
        background: rgba(102, 126, 234, 0.1);
    }
    
    .planilla-table .cargo-cell {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
        color: white;
        font-weight: bold;
        text-align: center;
        padding: 12px;
        border: 1px solid rgba(102, 126, 234, 0.5);
    }
    
    .planilla-table .selector-cell {
        padding: 8px;
    }
    
    .planilla-table select {
        width: 100%;
        padding: 8px;
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 4px;
        background: rgba(26, 26, 46, 0.9);
        color: #e8e8e8;
        font-size: 0.95rem;
        cursor: pointer;
    }
    
    .planilla-table select:focus {
        outline: 2px solid rgba(102, 126, 234, 0.6);
        border-color: rgba(102, 126, 234, 0.6);
        background: rgba(26, 26, 46, 1);
    }
    
    .planilla-table select option {
        background: rgba(26, 26, 46, 0.95);
        color: #e8e8e8;
    }
    
    .planilla-table .empty-cell {
        color: #999;
        font-style: italic;
    }
    
    .planilla-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn-add-row {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .btn-add-row:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    
    .btn-remove-row {
        background: rgba(244, 67, 54, 0.8);
        color: white;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }
    
    .btn-remove-row:hover {
        background: rgba(244, 67, 54, 1);
    }
    
    .planilla-table .row-actions {
        text-align: center;
        width: 80px;
    }
    
    /* Ajustar padding para el footer sticky */
    .admin-turnos {
        padding-bottom: 70px;
    }
    
    .historial-section {
        background: #252525;
        border-radius: 15px;
        padding: 25px;
        margin-top: 50px;
        margin-bottom: 30px;
    }
    
    .section-title {
        font-size: 2.2rem;
        color: #e8e8e8;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 3px solid rgba(102, 126, 234, 0.3);
        font-weight: bold;
    }
    
    .section-subtitle {
        color: #aaa;
        font-size: 1.2rem;
        margin-bottom: 25px;
    }
    
    .historial-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: #1a1a1a;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .historial-table thead th {
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        text-align: left;
        font-weight: bold;
        font-size: 1.2rem;
        border-bottom: 3px solid rgba(255, 255, 255, 0.1);
    }
    
    .historial-table tbody tr {
        background-color: #1a1a1a;
        transition: background-color 0.2s;
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .historial-table tbody tr:nth-child(even) {
        background-color: #222;
    }
    
    .historial-table tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.15);
    }
    
    .historial-table tbody td {
        padding: 20px;
        color: #e8e8e8;
        font-size: 1.1rem;
    }
    
    .historial-status {
        padding: 5px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: bold;
        display: inline-block;
    }
    
    .historial-status.abierto {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
    }
    
    .historial-status.cerrado {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
    }
    
    .view-close-detail-btn {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.5);
        color: #667eea;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
    }
    
    .view-close-detail-btn:hover {
        background: rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
    }
    
    .btn-close-historial {
        background: rgba(245, 87, 108, 0.2);
        border: 1px solid rgba(245, 87, 108, 0.5);
        color: #f5576c;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-close-historial:hover {
        background: rgba(245, 87, 108, 0.3);
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-turnos">
    <div class="turnos-header">
        <div class="turnos-header-left">
            <h1>‚è∞ Gesti√≥n de Turnos</h1>
            <p>Flujo completo de apertura de turno del d√≠a</p>
        </div>
        
        <div class="turnos-header-right">
            <label for="selector-jornada">üìÖ Seleccionar Jornada para Editar:</label>
            <select id="selector-jornada" onchange="cambiarJornada(this.value)">
                <option value="">-- Nueva Jornada (Hoy) --</option>
                {% for jornada in jornadas_historial %}
                <option value="{{ jornada.id }}" {% if jornada_id_actual == jornada.id %}selected{% endif %}>
                    {{ jornada.fecha_jornada|fecha_solo }} - {{ jornada.nombre_fiesta or 'Sin nombre' }} 
                    {% if jornada.estado_apertura == 'abierto' %}(üü¢ Abierto){% elif jornada.estado_apertura == 'cerrado' %}(üî¥ Cerrado){% else %}(‚è≥ Preparando){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="flujo-container">
        <!-- Paso 1: Login (ya est√° hecho) -->
        <div class="step-card completed collapsed" data-step="1">
            <div class="step-header" onclick="toggleStep(1)">
                <div class="step-number">1</div>
                <h2 class="step-title">Login del Administrador</h2>
                <span class="step-status completed">‚úÖ Completado</span>
                <span class="step-toggle">‚ñº</span>
            </div>
            <div class="step-summary">
                Sesi√≥n iniciada como: <strong>{{ session.get('admin_username', 'Admin') }}</strong>
            </div>
            <div class="step-content">
                <p style="color: #aaa;">Sesi√≥n iniciada como: <strong style="color: #e8e8e8;">{{ session.get('admin_username', 'Admin') }}</strong></p>
            </div>
        </div>
        
        <!-- Paso 2: Crear Turno -->
        <div class="step-card {% if jornada_actual %}completed collapsed{% else %}active{% endif %}" data-step="2">
            <div class="step-header" onclick="toggleStep(2)">
                <div class="step-number">2</div>
                <h2 class="step-title">Crear Turno del D√≠a</h2>
                <span class="step-status {% if jornada_actual %}completed{% else %}pending{% endif %}">
                    {% if jornada_actual %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
                </span>
                {% if jornada_actual %}<span class="step-toggle">‚ñº</span>{% endif %}
            </div>
            {% if jornada_actual %}
            <div class="step-summary">
                <strong>{{ jornada_actual.nombre_fiesta }}</strong> - {{ jornada_actual.fecha_jornada }} ({{ jornada_actual.tipo_turno }}) | {{ jornada_actual.horario_apertura_programado }} - {{ jornada_actual.horario_cierre_programado }}
            </div>
            {% endif %}
            <div class="step-content">
                {% if jornada_actual %}
                <form method="POST" action="{{ url_for('routes.actualizar_jornada') }}">
                    <input type="hidden" name="jornada_id" value="{{ jornada_actual.id }}">
                    <div class="form-group">
                        <label>Fecha del Turno</label>
                        <input type="date" name="fecha_jornada" value="{{ jornada_actual.fecha_jornada }}" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Turno</label>
                        <select name="tipo_turno" required>
                            <option value="Noche" {% if jornada_actual.tipo_turno == 'Noche' %}selected{% endif %}>Noche</option>
                            <option value="D√≠a" {% if jornada_actual.tipo_turno == 'D√≠a' %}selected{% endif %}>D√≠a</option>
                            <option value="Especial" {% if jornada_actual.tipo_turno == 'Especial' %}selected{% endif %}>Especial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nombre de Fiesta</label>
                        <input type="text" name="nombre_fiesta" value="{{ jornada_actual.nombre_fiesta or '' }}" placeholder="Ej: Fiesta Viernes" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Horario Apertura Programado</label>
                            <input type="time" name="horario_apertura_programado" value="{{ jornada_actual.horario_apertura_programado or '20:00' }}" required>
                        </div>
                        <div class="form-group">
                            <label>Horario Cierre Programado</label>
                            <input type="time" name="horario_cierre_programado" value="{{ jornada_actual.horario_cierre_programado or '04:00' }}" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">üíæ Actualizar Turno</button>
                </form>
                {% else %}
                <form method="POST" action="{{ url_for('routes.crear_jornada') }}">
                    <div class="form-group">
                        <label>Fecha del Turno</label>
                        <input type="date" name="fecha_jornada" value="{{ fecha_hoy }}" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Turno</label>
                        <select name="tipo_turno" required>
                            <option value="Noche">Noche</option>
                            <option value="D√≠a">D√≠a</option>
                            <option value="Especial">Especial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nombre de Fiesta</label>
                        <input type="text" name="nombre_fiesta" placeholder="Ej: Fiesta Viernes" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Horario Apertura Programado</label>
                            <input type="time" name="horario_apertura_programado" value="20:00" required>
                        </div>
                        <div class="form-group">
                            <label>Horario Cierre Programado</label>
                            <input type="time" name="horario_cierre_programado" value="04:00" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Crear Turno</button>
                </form>
                {% endif %}
            </div>
        </div>
        
        <!-- Paso 3: Planilla de Trabajadores -->
        <div class="step-card {% if jornada_actual and planilla_trabajadores|length > 0 %}completed collapsed{% elif jornada_actual %}active{% endif %}" data-step="3">
            <div class="step-header" onclick="toggleStep(3)">
                <div class="step-number">3</div>
                <h2 class="step-title">Planilla de Trabajadores</h2>
                <span class="step-status {% if jornada_actual and planilla_trabajadores|length > 0 %}completed{% elif jornada_actual %}pending{% else %}pending{% endif %}">
                    {% if jornada_actual and planilla_trabajadores|length > 0 %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
                </span>
                {% if jornada_actual and planilla_trabajadores|length > 0 %}<span class="step-toggle">‚ñº</span>{% endif %}
            </div>
            {% if jornada_actual and planilla_trabajadores|length > 0 %}
            <div class="step-summary">
                <strong>{{ planilla_trabajadores|length }} trabajador(es) asignado(s)</strong>
            </div>
            {% endif %}
            <div class="step-content">
                {% if jornada_actual %}
                    <form method="POST" action="{{ url_for('routes.asignar_planilla_responsables') }}" id="form-planilla" onsubmit="return validatePlanillaForm(event)">
                        <input type="hidden" name="jornada_id" value="{{ jornada_actual.id }}">
                        
                        <!-- Planilla de Trabajadores -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 class="section-title" style="margin: 0;">üë• Planilla de Trabajadores</h3>
                            <div id="planilla-modificada-indicator" style="display: none; background: rgba(255, 152, 0, 0.2); border: 1px solid rgba(255, 152, 0, 0.5); color: #ff9800; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;">
                                ‚ö†Ô∏è Tienes cambios sin guardar
                            </div>
                        </div>
                        
                        <!-- Formulario para agregar trabajador (siempre visible) -->
                        <div style="background: rgba(102, 126, 234, 0.1); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                            <h4 style="color: #e8e8e8; margin-top: 0; margin-bottom: 15px; font-size: 1.1rem;">‚ûï Agregar Trabajador a la Planilla</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label for="select-cargo-planilla" style="color: #e8e8e8; margin-bottom: 8px; display: block; font-weight: 600;">Seleccionar Cargo:</label>
                                    <select id="select-cargo-planilla" class="form-group select" style="width: 100%; padding: 12px; background: rgba(26, 26, 46, 0.9); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: #e8e8e8; font-size: 1rem;">
                                        <option value="">-- Seleccionar cargo --</option>
                                        <!-- Los cargos se cargar√°n din√°micamente -->
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label for="select-empleado-planilla" style="color: #e8e8e8; margin-bottom: 8px; display: block; font-weight: 600;">Seleccionar Trabajador:</label>
                                    <select id="select-empleado-planilla" class="form-group select" style="width: 100%; padding: 12px; background: rgba(26, 26, 46, 0.9); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: #e8e8e8; font-size: 1rem;">
                                        <option value="">-- Seleccionar trabajador --</option>
                                        <!-- Los trabajadores se cargar√°n din√°micamente -->
                                    </select>
                                </div>
                                <button type="button" onclick="agregarTrabajadorDesdeFormulario()" class="btn-primary" style="padding: 12px 24px; white-space: nowrap;">
                                    ‚ûï Agregar
                                </button>
                            </div>
                        </div>
                        
                        <div class="planilla-table-container">
                            <table class="planilla-table" id="planilla-table">
                                <thead>
                                    <tr>
                                        <th>SERVICIO</th>
                                        <th id="planilla-date-header">
                                            {% set fecha_actual = fecha_hoy %}
                                            {% if jornada_actual and jornada_actual.fecha_jornada %}
                                                {% set fecha_actual = jornada_actual.fecha_jornada %}
                                            {% endif %}
                                            {{ fecha_actual|fecha_solo }}
                                        </th>
                                        <th class="row-actions">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="planilla-tbody">
                                    <!-- Las filas se generar√°n din√°micamente con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <button type="submit" class="btn-primary" style="margin-top: 20px;">Guardar Planilla</button>
                    </form>
                {% else %}
                <p style="color: #aaa;">Primero debes crear el turno del d√≠a.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Paso 4: Abrir Local -->
        {% set puede_abrir = jornada_actual and planilla_trabajadores|length > 0 %}
        <div class="step-card {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}completed collapsed{% elif puede_abrir %}active{% endif %}" data-step="4">
            <div class="step-header" onclick="toggleStep(4)">
                <div class="step-number">4</div>
                <h2 class="step-title">Abrir Local</h2>
                <span class="step-status {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}completed{% elif puede_abrir %}pending{% else %}pending{% endif %}">
                    {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}‚úÖ Local Abierto{% else %}‚è≥ Pendiente{% endif %}
                </span>
                {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}<span class="step-toggle">‚ñº</span>{% endif %}
            </div>
            {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}
            <div class="step-summary">
                Abierto el {{ jornada_actual.abierto_en|fecha }} por {{ jornada_actual.abierto_por or 'N/A' }}
            </div>
            {% endif %}
            <div class="step-content">
                {% if jornada_actual %}
                    {% if jornada_actual.estado_apertura == 'abierto' %}
                    <div class="info-display">
                        <label>Estado</label>
                        <value>‚úÖ Local Abierto</value>
                    </div>
                    <div class="info-display">
                        <label>Abierto el</label>
                        <value>{{ jornada_actual.abierto_en|fecha }}</value>
                    </div>
                    <div class="info-display">
                        <label>Abierto por</label>
                        <value>{{ jornada_actual.abierto_por or 'N/A' }}</value>
                    </div>
                    <p style="color: #4caf50; margin-top: 20px;">
                        <strong>‚úÖ El sistema est√° habilitado para ventas, escaneo y control en tiempo real.</strong>
                    </p>
                    {% else %}
                    {% if puede_abrir %}
                    <p style="color: #aaa; margin-bottom: 20px;">
                        Una vez que abras el local, el sistema habilitar√°:
                    </p>
                    <ul style="color: #aaa; margin-bottom: 20px; padding-left: 20px;">
                        <li>Ventas en tiempo real</li>
                        <li>Escaneo de productos</li>
                        <li>Control de entregas</li>
                        <li>Monitoreo de cajas</li>
                    </ul>
                    <form method="POST" action="{{ url_for('routes.abrir_local') }}">
                        <input type="hidden" name="jornada_id" value="{{ jornada_actual.id }}">
                        <button type="submit" class="btn-success" onclick="return confirm('¬øEst√°s seguro de abrir el local? Esto habilitar√° todas las operaciones.');">
                            üöÄ Abrir Local
                        </button>
                    </form>
                    {% else %}
                    <p style="color: #ff9800;">
                        ‚ö†Ô∏è Debes completar los pasos anteriores antes de abrir el local:
                    </p>
                    <ul style="color: #aaa; padding-left: 20px;">
                        {% if planilla_trabajadores|length == 0 %}<li>Seleccionar al menos un trabajador en la planilla</li>{% endif %}
                    </ul>
                    <p style="color: #aaa; margin-top: 15px; font-size: 0.9rem;">
                        üí° <strong>Nota:</strong> Las cajas se abrir√°n autom√°ticamente cuando los cajeros se logueen en los puntos de venta.
                    </p>
                    {% endif %}
                    {% endif %}
                {% else %}
                <p style="color: #aaa;">Primero debes crear el turno del d√≠a.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Historial de Turnos -->
    <div class="historial-section">
        <h2 class="section-title">üìú Historial de Turnos</h2>
        <p class="section-subtitle">Historial de todos los turnos</p>
        
        {% if jornadas_historial %}
        <table class="historial-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fiesta</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Horario</th>
                    <th>Apertura</th>
                    <th>Estado</th>
                    <th style="text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for jornada in jornadas_historial %}
                <tr>
                    <td style="color: #aaa; font-weight: bold; text-align: center;">#{{ jornada.id }}</td>
                    <td style="color: #667eea; font-weight: bold;">{{ jornada.nombre_fiesta or 'Turno' }}</td>
                    <td>{{ jornada.fecha_jornada|fecha_solo }}</td>
                    <td>{{ jornada.tipo_turno }}</td>
                    <td style="color: #aaa; font-size: 0.85rem;">{{ jornada.horario_apertura_programado }} - {{ jornada.horario_cierre_programado }}</td>
                    <td style="color: #aaa; font-size: 0.85rem;">
                        {% if jornada.abierto_en %}{{ jornada.abierto_en|fecha }}{% else %}No abierto{% endif %}
                    </td>
                    <td>
                        <span class="historial-status {% if jornada.estado_apertura == 'abierto' %}abierto{% else %}cerrado{% endif %}">
                            {% if jornada.estado_apertura == 'abierto' %}üü¢ Abierto{% else %}üî¥ Cerrado{% endif %}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <a href="{{ url_for('routes.admin_turnos', jornada_id=jornada.id) }}" class="view-close-detail-btn" style="margin-right: 5px;">
                            ‚úèÔ∏è Editar
                        </a>
                        <a href="{{ url_for('routes.ver_detalle_jornada', jornada_id=jornada.id) }}" class="view-close-detail-btn" style="margin-right: 5px;">
                            üîç Ver
                        </a>
                        {% if jornada.estado_apertura == 'abierto' %}
                        <form method="POST" action="{{ url_for('routes.cerrar_jornada') }}" style="display: inline;">
                            <input type="hidden" name="jornada_id" value="{{ jornada.id }}">
                            <button type="submit" class="btn-close-historial" onclick="return confirm('¬øEst√°s seguro de cerrar este turno?');">
                                üîí Cerrar
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #aaa;">
            <p>No hay historial de turnos disponible</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function toggleStep(stepNum) {
    const stepCard = document.querySelector(`[data-step="${stepNum}"]`);
    if (stepCard && stepCard.classList.contains('completed')) {
        stepCard.classList.toggle('collapsed');
        
        // Si se expande el paso 3, cargar los cargos y empleados si a√∫n no se han cargado
        if (stepNum === 3 && !stepCard.classList.contains('collapsed')) {
            setTimeout(() => {
                // Verificar que los selectores existan antes de cargar (solo existen si hay jornada)
                const cargoSelect = document.getElementById('select-cargo-planilla');
                const empleadoSelect = document.getElementById('select-empleado-planilla');
                if (cargoSelect && empleadoSelect) {
                    loadCargosForPlanilla();
                    loadEmpleadosEnSelector();
                } else {
                    console.log('‚ÑπÔ∏è Los selectores a√∫n no est√°n disponibles. Se cargar√°n cuando se cree una jornada.');
                }
            }, 300); // Esperar a que la animaci√≥n termine
        }
    }
}

function cambiarJornada(jornadaId) {
    if (!jornadaId || jornadaId === '') {
        // Redirigir a nueva jornada (hoy)
        window.location.href = "{{ url_for('routes.admin_turnos') }}";
    } else {
        // Redirigir a jornada espec√≠fica
        window.location.href = "{{ url_for('routes.admin_turnos') }}?jornada_id=" + jornadaId;
    }
}

// Actualizar nombre del empleado cuando se selecciona uno en el formulario de caja
document.addEventListener('DOMContentLoaded', function() {
    const idEmpleadoCaja = document.getElementById('id_empleado_caja');
    const nombreEmpleadoCaja = document.getElementById('nombre_empleado_caja');
    
    if (idEmpleadoCaja && nombreEmpleadoCaja) {
        idEmpleadoCaja.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const nombre = selectedOption.getAttribute('data-name') || '';
            nombreEmpleadoCaja.value = nombre;
        });
    }
});

// Inicializar planilla al cargar la p√°gina
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Inicializando planilla...');
    
    // Asegurar que los empleados est√©n cargados antes de inicializar (usando cache)
    if (!empleadosDisponibles || empleadosDisponibles.length === 0) {
        console.log('üìã Cargando empleados disponibles al inicio...');
        empleadosDisponibles = await getEmpleadosDisponibles();
    }
    
    initializePlanilla();
    
    // Inicializar indicador de cambios
    updateModificadaIndicator();
    
    // Esperar un momento para asegurar que el DOM est√© completamente renderizado
    setTimeout(() => {
        console.log('üìã Verificando si hay jornada para cargar selectores...');
        
        // Verificar si existe una jornada (los selectores solo existen si hay jornada)
        const formPlanilla = document.getElementById('form-planilla');
        const cargoSelect = document.getElementById('select-cargo-planilla');
        const empleadoSelect = document.getElementById('select-empleado-planilla');
        
        if (!formPlanilla || !cargoSelect || !empleadoSelect) {
            console.log('‚ÑπÔ∏è No hay jornada actual. Los selectores se cargar√°n cuando se cree una jornada.');
            return; // No hay jornada, no intentar cargar selectores que no existen
        }
        
        console.log('üìã Cargando selectores del formulario...');
        loadCargosForPlanilla(); // Cargar cargos para el selector
        loadEmpleadosEnSelector(); // Cargar empleados en el selector
    }, 500); // Aumentar el delay para asegurar que el DOM est√© completamente listo
});

// Cargar cargos para el selector del formulario
function loadCargosForPlanilla(showLoading = false, retryCount = 0) {
    const maxRetries = 10; // M√°ximo de reintentos (10 * 500ms = 5 segundos)
    const cargoSelect = document.getElementById('select-cargo-planilla');
    
    if (!cargoSelect) {
        if (retryCount < maxRetries) {
            console.log(`‚ö†Ô∏è Selector de cargos no encontrado. Reintentando... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => loadCargosForPlanilla(showLoading, retryCount + 1), 500);
            return;
        } else {
            console.warn('‚ö†Ô∏è No se encontr√≥ el selector de cargos despu√©s de m√∫ltiples intentos. El formulario puede no estar disponible.');
            return;
        }
    }
    
    // El elemento existe, proceder a cargar los cargos
    // No importa si el paso est√° colapsado, los datos se cargar√°n y estar√°n disponibles cuando se expanda
    console.log('üìã Cargando cargos para el selector...');
    
    // Limpiar opciones existentes excepto la primera
    while (cargoSelect.options.length > 1) {
        cargoSelect.remove(1);
    }
    
    fetch('/admin/equipo/api/cargos', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        },
        cache: 'no-cache' // Evitar cache para obtener datos frescos
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üì¶ Datos de cargos recibidos:', data);
            if (data.success && data.cargos && data.cargos.length > 0) {
                // Filtrar solo cargos activos
                const cargosActivos = data.cargos.filter(cargo => cargo.activo !== false && cargo.is_active !== false);
                
                console.log(`‚úÖ Cargos activos encontrados: ${cargosActivos.length}`);
                
                if (cargosActivos.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '‚ö†Ô∏è No hay cargos activos disponibles';
                    option.disabled = true;
                    cargoSelect.appendChild(option);
                    return;
                }
                
                // Agregar cargos al selector
                cargosActivos.forEach(cargo => {
                    const option = document.createElement('option');
                    option.value = cargo.nombre || '';
                    option.textContent = cargo.nombre || 'Sin nombre';
                    cargoSelect.appendChild(option);
                });
                
                console.log(`‚úÖ ${cargosActivos.length} cargos cargados en el selector`);
            } else {
                console.error('‚ùå Respuesta inv√°lida de la API:', data);
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '‚ùå Error al cargar cargos';
                option.disabled = true;
                cargoSelect.appendChild(option);
            }
        })
        .catch(error => {
            console.error('‚ùå Error al cargar cargos:', error);
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '‚ùå Error de conexi√≥n';
            option.disabled = true;
            cargoSelect.appendChild(option);
        });
}

// Cargar empleados disponibles en el selector
function loadEmpleadosEnSelector(retryCount = 0) {
    const maxRetries = 10; // M√°ximo de reintentos (10 * 500ms = 5 segundos)
    const empleadoSelect = document.getElementById('select-empleado-planilla');
    
    if (!empleadoSelect) {
        if (retryCount < maxRetries) {
            console.log(`‚ö†Ô∏è Selector de empleados no encontrado. Reintentando... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => loadEmpleadosEnSelector(retryCount + 1), 500);
            return;
        } else {
            console.warn('‚ö†Ô∏è No se encontr√≥ el selector de empleados despu√©s de m√∫ltiples intentos. Puede que no haya jornada actual.');
            return;
        }
    }
    
    console.log('üë• Cargando empleados en el selector...');
    
    // Limpiar opciones existentes excepto la primera
    while (empleadoSelect.options.length > 1) {
        empleadoSelect.remove(1);
    }
    
    // Agregar empleados disponibles al selector
    if (empleadosDisponibles && empleadosDisponibles.length > 0) {
        console.log(`‚úÖ Agregando ${empleadosDisponibles.length} empleados al selector`);
        empleadosDisponibles.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = emp.name || 'Sin nombre';
            empleadoSelect.appendChild(option);
        });
        console.log(`‚úÖ ${empleadosDisponibles.length} empleados cargados en el selector`);
    } else {
        console.warn('‚ö†Ô∏è No hay empleados disponibles en la lista');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '‚ö†Ô∏è No hay empleados disponibles';
        option.disabled = true;
        empleadoSelect.appendChild(option);
        
        // Intentar recargar empleados
        reloadEmpleadosDisponibles().then(() => {
            if (empleadosDisponibles && empleadosDisponibles.length > 0) {
                loadEmpleadosEnSelector(); // Recargar el selector
            }
        });
    }
}

// Funci√≥n para verificar si un trabajador ya existe en la planilla
function existeTrabajadorEnPlanilla(empleadoId, cargo) {
    const rows = document.querySelectorAll('#planilla-tbody tr');
    for (let row of rows) {
        const select = row.querySelector('select[name*="[empleado_id]"]');
        const cargoCell = row.querySelector('.cargo-cell');
        if (select && cargoCell) {
            const empleadoIdExistente = select.value.trim();
            const cargoExistente = cargoCell.textContent.trim();
            if (empleadoIdExistente === empleadoId && cargoExistente === cargo) {
                return true;
            }
        }
    }
    return false;
}

// Funci√≥n para agregar trabajador desde el formulario
function agregarTrabajadorDesdeFormulario() {
    const cargoSelect = document.getElementById('select-cargo-planilla');
    const empleadoSelect = document.getElementById('select-empleado-planilla');
    
    if (!cargoSelect || !empleadoSelect) {
        alert('‚ö†Ô∏è Error: No se encontraron los selectores del formulario.');
        console.error('‚ùå Selectores no encontrados:', { cargoSelect, empleadoSelect });
        return;
    }
    
    // Obtener el texto seleccionado, no solo el value (por si acaso)
    const cargoSeleccionado = cargoSelect.value.trim();
    const cargoText = cargoSelect.options[cargoSelect.selectedIndex]?.text || cargoSeleccionado;
    const empleadoIdSeleccionado = empleadoSelect.value.trim();
    
    console.log('üìù Datos del formulario:', {
        cargoValue: cargoSeleccionado,
        cargoText: cargoText,
        empleadoId: empleadoIdSeleccionado
    });
    
    // Validar que ambos campos est√©n seleccionados
    if (!cargoSeleccionado || cargoSeleccionado === '' || cargoSeleccionado === '-- Seleccionar cargo --') {
        alert('‚ö†Ô∏è Por favor, selecciona un cargo primero.');
        cargoSelect.focus();
        return;
    }
    
    if (!empleadoIdSeleccionado || empleadoIdSeleccionado === '' || empleadoIdSeleccionado === '-- Seleccionar trabajador --') {
        alert('‚ö†Ô∏è Por favor, selecciona un trabajador primero.');
        empleadoSelect.focus();
        return;
    }
    
    // Validar duplicados
    if (existeTrabajadorEnPlanilla(empleadoIdSeleccionado, cargoSeleccionado)) {
        const empleadoSeleccionado = empleadosDisponibles.find(emp => emp.id === empleadoIdSeleccionado);
        const nombreEmpleado = empleadoSeleccionado ? empleadoSeleccionado.name : 'este trabajador';
        alert(`‚ö†Ô∏è ${nombreEmpleado} ya est√° asignado al cargo "${cargoSeleccionado}" en la planilla. No se pueden agregar duplicados.`);
        empleadoSelect.focus();
        return;
    }
    
    // Obtener el nombre del empleado seleccionado
    const empleadoSeleccionado = empleadosDisponibles.find(emp => emp.id === empleadoIdSeleccionado);
    const empleadoName = empleadoSeleccionado ? empleadoSeleccionado.name : '';
    
    console.log('‚úÖ Agregando trabajador:', {
        cargo: cargoSeleccionado,
        empleadoId: empleadoIdSeleccionado,
        empleadoName: empleadoName
    });
    
    // Agregar la fila a la planilla - usar cargoSeleccionado que es el value del select
    addPlanillaRow(cargoSeleccionado, empleadoIdSeleccionado, empleadoName);
    
    // Marcar planilla como modificada
    planillaModificada = true;
    updateModificadaIndicator();
    
    // Limpiar los selectores
    cargoSelect.value = '';
    empleadoSelect.value = '';
    
    // Enfocar el selector de cargo para facilitar agregar otro
    cargoSelect.focus();
}

// Variables globales para la planilla
let planillaRowCounter = 0;
let planillaModificada = false; // Indicador de cambios no guardados
let empleadosDisponibles = [
    {% for emp in empleados_disponibles %}
    {
        id: '{{ emp.id }}',
        name: '{{ emp.name|replace("'", "\\'") }}',
        cargo: '{{ emp.cargo or "" }}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Cache de empleados para optimizar carga
let empleadosCache = null;
let cacheTimestamp = null;
const CACHE_DURATION = 60000; // 1 minuto

// Funci√≥n para obtener empleados disponibles (con cache)
async function getEmpleadosDisponibles() {
    // Verificar cache
    if (empleadosCache && cacheTimestamp && 
        Date.now() - cacheTimestamp < CACHE_DURATION) {
        console.log('üì¶ Usando cache de empleados');
        return empleadosCache;
    }
    
    // Cargar desde API
    const cargado = await reloadEmpleadosDisponibles();
    if (cargado && empleadosDisponibles && empleadosDisponibles.length > 0) {
        empleadosCache = empleadosDisponibles;
        cacheTimestamp = Date.now();
    }
    
    return empleadosDisponibles || [];
}

// Funci√≥n para recargar empleados disponibles desde la API si es necesario
async function reloadEmpleadosDisponibles(retryCount = 0) {
    const maxRetries = 3;
    
    try {
        // Intentar primero con la ruta del equipo
        let response = await fetch('/admin/equipo/api/employees', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            cache: 'no-cache' // Evitar cache para obtener datos frescos
        });
        
        let data;
        
        if (response.ok) {
            data = await response.json();
        } else {
            // Fallback: intentar con la ruta legacy
            console.log('‚ö†Ô∏è Ruta del equipo fall√≥, intentando ruta legacy...');
            response = await fetch('/admin/api/employees', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'no-cache'
            });
            if (response.ok) {
                data = await response.json();
            }
        }
        
        if (data && data.success && data.employees) {
            // Filtrar solo empleados activos
            empleadosDisponibles = data.employees
                .filter(emp => emp.active !== false)
                .map(emp => ({
                    id: String(emp.id),
                    name: emp.name || 'Sin nombre',
                    cargo: emp.cargo || ''
                }));
            console.log(`‚úÖ Empleados disponibles recargados: ${empleadosDisponibles.length} empleados activos`);
            return true;
        } else if (retryCount < maxRetries) {
            // Retry con delay exponencial
            console.log(`‚ö†Ô∏è Intento ${retryCount + 1} fall√≥, reintentando en ${(retryCount + 1) * 500}ms...`);
            await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 500));
            return await reloadEmpleadosDisponibles(retryCount + 1);
        }
    } catch (error) {
        console.error(`Error al recargar empleados (intento ${retryCount + 1}):`, error);
        if (retryCount < maxRetries) {
            // Retry con delay exponencial
            await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 500));
            return await reloadEmpleadosDisponibles(retryCount + 1);
        }
    }
    return false;
}
let planillaAsignaciones = [
    {% for trabajador in planilla_trabajadores %}
    {
        rowId: 'row_{{ loop.index }}',
        cargo: '{{ trabajador.rol|replace("'", "\\'") }}',
        empleadoId: '{{ trabajador.id_empleado|replace("'", "\\'") }}',
        empleadoName: '{{ trabajador.nombre_empleado|replace("'", "\\'") }}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

function initializePlanilla() {
    const tbody = document.getElementById('planilla-tbody');
    if (!tbody) return;
    
    // Si hay asignaciones existentes, cargarlas
    if (planillaAsignaciones.length > 0) {
        planillaAsignaciones.forEach(asignacion => {
            addPlanillaRow(asignacion.cargo, asignacion.empleadoId, asignacion.empleadoName);
        });
    }
}

async function addPlanillaRow(cargo, empleadoId = '', empleadoName = '') {
    const tbody = document.getElementById('planilla-tbody');
    if (!tbody) {
        console.error('‚ùå No se encontr√≥ el tbody de la planilla');
        return;
    }
    
    // Validar que el cargo no est√© vac√≠o
    if (!cargo || cargo.trim() === '') {
        console.error('‚ùå No se puede agregar una fila sin cargo');
        alert('‚ö†Ô∏è Error: No se puede agregar una fila sin especificar el cargo.');
        return;
    }
    
    // Normalizar el cargo (trim y asegurar que sea string)
    cargo = String(cargo).trim();
    
    // Si no hay empleados disponibles, intentar recargarlos usando cache
    if (!empleadosDisponibles || empleadosDisponibles.length === 0) {
        console.log('‚ö†Ô∏è No hay empleados disponibles, intentando cargar...');
        empleadosDisponibles = await getEmpleadosDisponibles();
        if (!empleadosDisponibles || empleadosDisponibles.length === 0) {
            console.error('‚ùå No se pudieron cargar empleados disponibles');
            alert('‚ö†Ô∏è No se pudieron cargar los empleados disponibles. Por favor, recarga la p√°gina.');
            return;
        }
    }
    
    planillaRowCounter++;
    const rowId = `planilla_row_${planillaRowCounter}`;
    
    // Crear fila
    const row = document.createElement('tr');
    row.id = rowId;
    row.dataset.cargo = cargo;
    
    // Celda de SERVICIO (cargo) - Asegurar que siempre tenga contenido
    const servicioCell = document.createElement('td');
    servicioCell.className = 'cargo-cell';
    // Asegurar que el cargo siempre tenga un valor v√°lido
    const cargoDisplay = cargo && cargo.trim() !== '' ? cargo.trim() : 'SIN CARGO';
    servicioCell.textContent = cargoDisplay;
    servicioCell.setAttribute('data-cargo', cargoDisplay); // Atributo adicional para debugging
    servicioCell.setAttribute('data-original-cargo', cargo); // Guardar el cargo original
    row.appendChild(servicioCell);
    
    console.log(`‚úÖ Agregando fila para cargo: "${cargoDisplay}" (rowId: ${rowId}, cargo original: "${cargo}")`);
    
    // Celda de selector de empleado
    const selectorCell = document.createElement('td');
    selectorCell.className = 'selector-cell';
    const select = document.createElement('select');
    select.name = `planilla[${rowId}][empleado_id]`;
    select.dataset.rowId = rowId;
    select.required = true;
    select.setAttribute('required', 'required');
    
    // Agregar evento para validar cuando cambia la selecci√≥n
    select.addEventListener('change', function() {
        // Remover estilo de error si se selecciona un empleado
        if (this.value !== '') {
            row.style.border = '';
            row.style.backgroundColor = '';
            // Marcar planilla como modificada
            planillaModificada = true;
            updateModificadaIndicator();
        }
    });
    
    // Opci√≥n vac√≠a
    const emptyOption = document.createElement('option');
    emptyOption.value = '';
    emptyOption.textContent = '-- Seleccionar --';
    if (!empleadoId) {
        emptyOption.selected = true;
    }
    select.appendChild(emptyOption);
    
    // Opciones de empleados - solo mostrar nombre, sin cargo
    if (empleadosDisponibles && empleadosDisponibles.length > 0) {
        empleadosDisponibles.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            // Asegurar que solo se muestre el nombre, sin cargo ni informaci√≥n adicional
            const nombreLimpio = emp.name ? emp.name.trim() : 'Sin nombre';
            option.textContent = nombreLimpio;
            if (emp.id === empleadoId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    } else {
        // Si no hay empleados disponibles, mostrar mensaje
        const noEmpleadosOption = document.createElement('option');
        noEmpleadosOption.value = '';
        noEmpleadosOption.textContent = '‚ö†Ô∏è No hay empleados disponibles';
        noEmpleadosOption.disabled = true;
        select.appendChild(noEmpleadosOption);
        console.warn('‚ö†Ô∏è No hay empleados disponibles para agregar a la planilla');
    }
    
    selectorCell.appendChild(select);
    row.appendChild(selectorCell);
    
    // Celda de acciones
    const actionsCell = document.createElement('td');
    actionsCell.className = 'row-actions';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn-remove-row';
    removeBtn.textContent = 'üóëÔ∏è';
    removeBtn.onclick = () => removePlanillaRow(rowId);
    actionsCell.appendChild(removeBtn);
    row.appendChild(actionsCell);
    
    // Input hidden para el cargo (rol)
    const cargoInput = document.createElement('input');
    cargoInput.type = 'hidden';
    cargoInput.name = `planilla[${rowId}][cargo]`;
    cargoInput.value = cargo;
    row.appendChild(cargoInput);
    
    // Input hidden para el servicio/area (usar el mismo cargo como servicio)
    const servicioInput = document.createElement('input');
    servicioInput.type = 'hidden';
    servicioInput.name = `planilla[${rowId}][area]`;
    servicioInput.value = cargo; // El servicio es el mismo que el cargo
    row.appendChild(servicioInput);
    
    tbody.appendChild(row);
}

function removePlanillaRow(rowId) {
    const row = document.getElementById(rowId);
    if (!row) return;
    
    // Obtener informaci√≥n de la fila para el mensaje de confirmaci√≥n
    const cargoCell = row.querySelector('.cargo-cell');
    const select = row.querySelector('select[name*="[empleado_id]"]');
    const cargo = cargoCell ? cargoCell.textContent.trim() : 'trabajador';
    
    let nombreEmpleado = 'este trabajador';
    if (select && select.value) {
        const empleado = empleadosDisponibles.find(emp => emp.id === select.value);
        if (empleado) {
            nombreEmpleado = empleado.name;
        }
    }
    
    // Confirmar antes de eliminar
    if (!confirm(`¬øEst√°s seguro de eliminar a ${nombreEmpleado} (${cargo}) de la planilla?`)) {
        return;
    }
    
    // Eliminar la fila
    row.remove();
    
    // Marcar planilla como modificada
    planillaModificada = true;
    updateModificadaIndicator();
    
    console.log(`üóëÔ∏è Fila eliminada: ${nombreEmpleado} (${cargo})`);
}

// Validar formulario antes de enviar - NO permitir filas sin empleado seleccionado
function validatePlanillaForm(event) {
    console.log('üîç Validando formulario de planilla...');
    
    // Remover el atributo required de los selectores del formulario de agregar (no deben bloquear el guardado)
    const cargoSelect = document.getElementById('select-cargo-planilla');
    const empleadoSelect = document.getElementById('select-empleado-planilla');
    if (cargoSelect) {
        cargoSelect.removeAttribute('required');
    }
    if (empleadoSelect) {
        empleadoSelect.removeAttribute('required');
    }
    
    const tbody = document.getElementById('planilla-tbody');
    if (!tbody) {
        alert('‚ö†Ô∏è No hay trabajadores en la planilla. Agrega trabajadores primero.');
        event.preventDefault();
        return false;
    }
    
    const rows = tbody.querySelectorAll('tr');
    if (rows.length === 0) {
        alert('‚ö†Ô∏è La planilla est√° vac√≠a. Agrega al menos un trabajador antes de guardar.');
        event.preventDefault();
        return false;
    }
    
    let filasVacias = [];
    let filasValidas = 0;
    
    // Verificar cada fila
    rows.forEach((row, index) => {
        const select = row.querySelector('select[name*="[empleado_id]"]');
        if (!select) {
            console.warn(`‚ö†Ô∏è Fila ${index + 1} no tiene selector de empleado, omitiendo...`);
            return;
        }
        
        if (select.value === '' || select.value === null || select.value === undefined) {
            // Esta fila no tiene empleado seleccionado
            filasVacias.push(index + 1);
            // Resaltar visualmente la fila vac√≠a
            row.style.border = '2px solid #f44336';
            row.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
            
            // Eliminar inputs hidden de esta fila para que no se env√≠e
            const hiddenInputs = row.querySelectorAll('input[type="hidden"]');
            hiddenInputs.forEach(input => {
                console.log(`üóëÔ∏è Eliminando input hidden de fila vac√≠a: ${input.name}`);
                input.remove();
            });
        } else {
            filasValidas++;
            // Restaurar estilo normal
            row.style.border = '';
            row.style.backgroundColor = '';
            console.log(`‚úÖ Fila ${index + 1} v√°lida: empleado ${select.value}`);
        }
    });
    
    console.log(`üìä Resumen de validaci√≥n: ${filasValidas} filas v√°lidas, ${filasVacias.length} filas vac√≠as`);
    
    // Si hay filas vac√≠as, NO permitir guardar
    if (filasVacias.length > 0) {
        const mensaje = filasVacias.length === 1 
            ? `‚ö†Ô∏è La fila ${filasVacias[0]} no tiene un empleado seleccionado. Por favor, selecciona un empleado o elimina la fila antes de guardar.`
            : `‚ö†Ô∏è Las filas ${filasVacias.join(', ')} no tienen empleados seleccionados. Por favor, selecciona empleados o elimina las filas vac√≠as antes de guardar.`;
        
        alert(mensaje);
        event.preventDefault();
        return false;
    }
    
    // Si no hay filas v√°lidas, prevenir env√≠o
    if (filasValidas === 0) {
        alert('‚ö†Ô∏è Debes seleccionar al menos un empleado en la planilla antes de guardar.');
        event.preventDefault();
        return false;
    }
    
    console.log('‚úÖ Validaci√≥n exitosa, enviando formulario...');
    
    // Marcar planilla como guardada
    planillaModificada = false;
    updateModificadaIndicator();
    
    return true;
}

// Funci√≥n para actualizar el indicador visual de cambios no guardados
function updateModificadaIndicator() {
    const indicator = document.getElementById('planilla-modificada-indicator');
    if (indicator) {
        if (planillaModificada) {
            indicator.style.display = 'block';
        } else {
            indicator.style.display = 'none';
        }
    }
}

// Prevenir salir sin guardar si hay cambios
window.addEventListener('beforeunload', function(e) {
    if (planillaModificada) {
        e.preventDefault();
        e.returnValue = 'Tienes cambios sin guardar en la planilla. ¬øEst√°s seguro de salir?';
        return e.returnValue;
    }
});
</script>
{% endblock %}
