{% extends "base.html" %}
{% block title %}Gesti√≥n de Turnos - Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Header -->
    <div class="admin-page-header">
        <h1 class="page-title">‚è∞ Gesti√≥n de Turnos
        {% if jornada and jornada.estado_apertura == 'abierto' %}(üü¢ Abierto){% elif jornada and jornada.estado_apertura == 'cerrado' %}(üî¥ Cerrado){% else %}(‚è≥ Preparando){% endif %}
        </h1>
    </div>
</div>

<!-- Paso 1: Login -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Login del Administrador</h3>
        <span class="badge badge-success">‚úÖ Completado</span>
    </div>
    <p style="color: #aaa;">Sesi√≥n iniciada como: <strong style="color: #e8e8e8;">{{ session.get('admin_username',
            'Admin') }}</strong></p>
</div>

<!-- Paso 2: Crear Turno -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Crear Turno del D√≠a</h3>
        <span class="badge {% if jornada_actual %}badge-success{% else %}badge-warning{% endif %}">
            {% if jornada_actual %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
        </span>
    </div>

    {% if jornada_actual %}
    <p><strong>{{ jornada_actual.nombre_fiesta }}</strong> - {{ jornada_actual.fecha_jornada }} ({{
        jornada_actual.tipo_turno }}) | {{ jornada_actual.horario_apertura_programado }} - {{
        jornada_actual.horario_cierre_programado }}</p>

    <form method="POST" action="{{ url_for('routes.actualizar_jornada') }}">
        <input type="hidden" name="jornada_id" value="{{ jornada_actual.id }}">
        <div class="form-group">
            <label>Fecha del Turno</label>
            <input type="date" name="fecha_jornada" value="{{ jornada_actual.fecha_jornada }}" required
                class="form-control">
        </div>
        <div class="form-group">
            <label>Tipo de Turno</label>
            <select name="tipo_turno" required class="form-control">
                <option value="Noche" {% if jornada_actual.tipo_turno=='Noche' %}selected{% endif %}>Noche</option>
                <option value="D√≠a" {% if jornada_actual.tipo_turno=='D√≠a' %}selected{% endif %}>D√≠a</option>
                <option value="Especial" {% if jornada_actual.tipo_turno=='Especial' %}selected{% endif %}>Especial
                </option>
            </select>
        </div>
        <div class="form-group">
            <label>Nombre de Fiesta</label>
            <input type="text" name="nombre_fiesta" value="{{ jornada_actual.nombre_fiesta or '' }}"
                placeholder="Ej: Fiesta Viernes" required class="form-control">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Horario Apertura Programado</label>
                <input type="time" name="horario_apertura_programado"
                    value="{{ jornada_actual.horario_apertura_programado or '20:00' }}" required class="form-control">
            </div>
            <div class="form-group">
                <label>Horario Cierre Programado</label>
                <input type="time" name="horario_cierre_programado"
                    value="{{ jornada_actual.horario_cierre_programado or '04:00' }}" required class="form-control">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">üíæ Actualizar Turno</button>
    </form>
    {% else %}
    <form method="POST" action="{{ url_for('routes.crear_jornada') }}">
        <div class="form-group">
            <label>Fecha del Turno</label>
            <input type="date" name="fecha_jornada" value="{{ fecha_hoy }}" required class="form-control">
        </div>
        <div class="form-group">
            <label>Tipo de Turno</label>
            <select name="tipo_turno" required class="form-control">
                <option value="Noche">Noche</option>
                <option value="D√≠a">D√≠a</option>
                <option value="Especial">Especial</option>
            </select>
        </div>
        <div class="form-group">
            <label>Nombre de Fiesta</label>
            <input type="text" name="nombre_fiesta" placeholder="Ej: Fiesta Viernes" required class="form-control">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Horario Apertura Programado</label>
                <input type="time" name="horario_apertura_programado" value="20:00" required class="form-control">
            </div>
            <div class="form-group">
                <label>Horario Cierre Programado</label>
                <input type="time" name="horario_cierre_programado" value="04:00" required class="form-control">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Crear Turno</button>
    </form>
    {% endif %}
</div>

<!-- Paso 3: Planilla de Trabajadores -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Planilla de Trabajadores</h3>
        <span
            class="badge {% if jornada_actual and planilla_trabajadores|length > 0 %}badge-success{% else %}badge-warning{% endif %}">
            {% if jornada_actual and planilla_trabajadores|length > 0 %}‚úÖ Completado{% else %}‚è≥ Pendiente{% endif %}
        </span>
    </div>

    {% if jornada_actual %}
    <p><strong>{{ planilla_trabajadores|length }} trabajador(es) asignado(s)</strong></p>

    <form method="POST" action="{{ url_for('routes.asignar_planilla_responsables') }}" id="form-planilla">
        <input type="hidden" name="jornada_id" value="{{ jornada_actual.id }}">

        <div
            style="background: rgba(102, 126, 234, 0.1); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin-top: 0;">‚ûï Agregar Trabajador a la Planilla</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label for="select-cargo-planilla">Seleccionar Cargo:</label>
                    <select id="select-cargo-planilla" class="form-control">
                        <option value="">-- Seleccionar cargo --</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label for="select-empleado-planilla">Seleccionar Trabajador:</label>
                    <select id="select-empleado-planilla" class="form-control">
                        <option value="">-- Seleccionar trabajador --</option>
                    </select>
                </div>
                <button type="button" onclick="agregarTrabajadorDesdeFormulario()" class="btn btn-primary">‚ûï
                    Agregar</button>
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="planilla-table">
                <thead>
                    <tr>
                        <th>SERVICIO</th>
                        <th>{{ (jornada_actual.fecha_jornada if jornada_actual else fecha_hoy) }}</th>
                        <th style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="planilla-tbody">
                    <!-- Se genera din√°micamente con JavaScript -->
                </tbody>
            </table>
        </div>

        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">Guardar Planilla</button>
    </form>
    {% else %}
    <p style="color: #aaa;">Primero debes crear el turno del d√≠a.</p>
    {% endif %}
</div>

<!-- Paso 4: Abrir Local -->
{% set puede_abrir = jornada_actual and planilla_trabajadores|length > 0 %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Abrir Local</h3>
        <span
            class="badge {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}badge-success{% else %}badge-warning{% endif %}">
            {% if jornada_actual and jornada_actual.estado_apertura == 'abierto' %}‚úÖ Local Abierto{% else %}‚è≥
            Pendiente{% endif %}
        </span>
    </div>

    {% if jornada_actual %}
    {% if jornada_actual.estado_apertura == 'abierto' %}
    <p style="color: #4caf50;"><strong>‚úÖ El sistema est√° habilitado para ventas, escaneo y control en tiempo
            real.</strong></p>
    <p>Abierto el {{ jornada_actual.abierto_en|fecha }} por {{ jornada_actual.abierto_por or 'N/A' }}</p>
    {% else %}
    {% if puede_abrir %}
    <p style="color: #aaa;">Una vez que abras el local, el sistema habilitar√° ventas en tiempo real, escaneo de
        productos, control de entregas y monitoreo de cajas.</p>
    <form method="POST" action="{{ url_for('routes.abrir_local') }}">
        <input type="hidden" name="jornada_id" value="{{ jornada_actual.id }}">
        <button type="submit" class="btn btn-primary"
            onclick="return confirm('¬øEst√°s seguro de abrir el local? Esto habilitar√° todas las operaciones.');">üöÄ
            Abrir Local</button>
    </form>
    {% else %}
    <p style="color: #ff9800;">‚ö†Ô∏è Debes completar los pasos anteriores antes de abrir el local.</p>
    {% endif %}
    {% endif %}
    {% else %}
    <p style="color: #aaa;">Primero debes crear el turno del d√≠a.</p>
    {% endif %}
</div>

<!-- Historial de Turnos -->
<div class="card" style="margin-top: 40px;">
    <div class="card-header">
        <h2 class="card-title">üìú Historial de Turnos</h2>
    </div>

    {% if jornadas_historial and jornadas_historial|length > 0 %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Fiesta</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Horario</th>
                    <th>Apertura</th>
                    <th>Estado</th>
                    <th style="text-align: center;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for jornada in jornadas_historial %}
                <tr>
                    <td>#{{ jornada.id }}</td>
                    <td><strong>{{ jornada.nombre_fiesta or 'Turno' }}</strong></td>
                    <td>{{ jornada.fecha_jornada }}</td>
                    <td>{{ jornada.tipo_turno }}</td>
                    <td style="font-size: 0.9rem;">{{ jornada.horario_apertura_programado }} - {{
                        jornada.horario_cierre_programado }}</td>
                    <td style="font-size: 0.9rem;">{% if jornada.abierto_en %}{{ jornada.abierto_en|fecha }}{% else
                        %}No abierto{% endif %}</td>
                    <td>
                        <span
                            class="badge {% if jornada.estado_apertura == 'abierto' %}badge-success{% else %}badge-warning{% endif %}">
                            {% if jornada.estado_apertura == 'abierto' %}üü¢ Abierto{% else %}üî¥ Cerrado{% endif %}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <a href="{{ url_for('routes.admin_turnos', jornada_id=jornada.id) }}"
                            class="btn btn-sm btn-secondary">‚úèÔ∏è Editar</a>
                        <a href="{{ url_for('routes.ver_detalle_jornada', jornada_id=jornada.id) }}"
                            class="btn btn-sm btn-secondary">üîç Ver</a>
                        {% if jornada.estado_apertura == 'abierto' %}
                        <form method="POST" action="{{ url_for('routes.cerrar_jornada') }}" style="display: inline;">
                            <input type="hidden" name="jornada_id" value="{{ jornada.id }}">
                            <button type="submit" class="btn btn-sm btn-danger"
                                onclick="return confirm('¬øEst√°s seguro de cerrar este turno?');">üîí Cerrar</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #aaa;">
        <p style="font-size: 1.1rem; margin-bottom: 10px;">üì≠ No hay historial de turnos disponible</p>
        <p style="font-size: 0.9rem; color: #888;">Crea tu primer turno para comenzar</p>
    </div>
    {% endif %}
</div>
</div>

<script>
    function cambiarJornada(jornadaId) {
        if (!jornadaId || jornadaId === '') {
            window.location.href = "{{ url_for('routes.admin_turnos') }}";
        } else {
            window.location.href = "{{ url_for('routes.admin_turnos') }}?jornada_id=" + jornadaId;
        }
    }

    // TODO: Agregar aqu√≠ el JavaScript necesario para la planilla
    // Variables globales para la planilla
    let planillaRowCounter = 0;
    let planillaModificada = false;
    let empleadosDisponibles = [
        {% for emp in empleados_disponibles %}
    { id: '{{ emp.id }}', name: '{{ emp.name|replace("'", "\\'") }}', cargo: '{{ emp.cargo or "" }}' } {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];

    let planillaAsignaciones = [
        {% for trabajador in planilla_trabajadores %}
    { rowId: 'row_{{ loop.index }}', cargo: '{{ trabajador.rol|replace("'", "\\'") }}', empleadoId: '{{ trabajador.id_empleado|replace("'", "\\'") }}', empleadoName: '{{ trabajador.nombre_empleado|replace("'", "\\'") }}' } {% if not loop.last %}, {% endif %}
    {% endfor %}
    ];

    // Cache de empleados
    let empleadosCache = null;
    let cacheTimestamp = null;
    const CACHE_DURATION = 60000;

    async function getEmpleadosDisponibles() {
        if (empleadosCache && cacheTimestamp && Date.now() - cacheTimestamp < CACHE_DURATION) {
            return empleadosCache;
        }
        const cargado = await reloadEmpleadosDisponibles();
        if (cargado && empleadosDisponibles && empleadosDisponibles.length > 0) {
            empleadosCache = empleadosDisponibles;
            cacheTimestamp = Date.now();
        }
        return empleadosDisponibles || [];
    }

    async function reloadEmpleadosDisponibles(retryCount = 0) {
        const maxRetries = 3;
        try {
            let response = await fetch('/admin/equipo/api/employees', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                cache: 'no-cache'
            });

            let data;
            if (response.ok) {
                data = await response.json();
            } else {
                response = await fetch('/admin/api/employees', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-cache'
                });
                if (response.ok) {
                    data = await response.json();
                }
            }

            if (data && data.success && data.employees) {
                empleadosDisponibles = data.employees
                    .filter(emp => emp.active !== false)
                    .map(emp => ({ id: String(emp.id), name: emp.name || 'Sin nombre', cargo: emp.cargo || '' }));
                return true;
            } else if (retryCount < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 500));
                return await reloadEmpleadosDisponibles(retryCount + 1);
            }
        } catch (error) {
            if (retryCount < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 500));
                return await reloadEmpleadosDisponibles(retryCount + 1);
            }
        }
        return false;
    }

    function initializePlanilla() {
        const tbody = document.getElementById('planilla-tbody');
        if (!tbody) return;
        if (planillaAsignaciones.length > 0) {
            planillaAsignaciones.forEach(asignacion => {
                addPlanillaRow(asignacion.cargo, asignacion.empleadoId, asignacion.empleadoName);
            });
        }
    }

    async function addPlanillaRow(cargo, empleadoId = '', empleadoName = '') {
        const tbody = document.getElementById('planilla-tbody');
        if (!tbody) return;
        if (!cargo || cargo.trim() === '') return;
        cargo = String(cargo).trim();

        if (!empleadosDisponibles || empleadosDisponibles.length === 0) {
            empleadosDisponibles = await getEmpleadosDisponibles();
            if (!empleadosDisponibles || empleadosDisponibles.length === 0) return;
        }

        planillaRowCounter++;
        const rowId = `planilla_row_${planillaRowCounter}`;
        const row = document.createElement('tr');
        row.id = rowId;
        row.dataset.cargo = cargo;

        const servicioCell = document.createElement('td');
        servicioCell.style.cssText = 'background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%); color: white; font-weight: bold; text-align: center; padding: 12px;';
        servicioCell.textContent = cargo;
        row.appendChild(servicioCell);

        const selectorCell = document.createElement('td');
        selectorCell.style.padding = '8px';
        const select = document.createElement('select');
        select.name = `planilla[${rowId}][empleado_id]`;
        select.dataset.rowId = rowId;
        select.required = true;
        select.style.cssText = 'width: 100%; padding: 8px; border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 4px; background: rgba(26, 26, 46, 0.9); color: #e8e8e8;';

        select.addEventListener('change', function () {
            if (this.value !== '') {
                row.style.border = '';
                row.style.backgroundColor = '';
                planillaModificada = true;
                updateModificadaIndicator();
            }
        });

        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Seleccionar --';
        if (!empleadoId) emptyOption.selected = true;
        select.appendChild(emptyOption);

        if (empleadosDisponibles && empleadosDisponibles.length > 0) {
            empleadosDisponibles.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name.trim();
                if (emp.id === empleadoId) option.selected = true;
                select.appendChild(option);
            });
        }

        selectorCell.appendChild(select);
        row.appendChild(selectorCell);

        const actionsCell = document.createElement('td');
        actionsCell.style.textAlign = 'center';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'üóëÔ∏è';
        removeBtn.style.cssText = 'background: rgba(244, 67, 54, 0.8); color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer;';
        removeBtn.onclick = () => removePlanillaRow(rowId);
        actionsCell.appendChild(removeBtn);
        row.appendChild(actionsCell);

        const cargoInput = document.createElement('input');
        cargoInput.type = 'hidden';
        cargoInput.name = `planilla[${rowId}][cargo]`;
        cargoInput.value = cargo;
        row.appendChild(cargoInput);

        const servicioInput = document.createElement('input');
        servicioInput.type = 'hidden';
        servicioInput.name = `planilla[${rowId}][area]`;
        servicioInput.value = cargo;
        row.appendChild(servicioInput);

        tbody.appendChild(row);
    }

    function removePlanillaRow(rowId) {
        const row = document.getElementById(rowId);
        if (!row) return;
        const cargoCell = row.querySelector('td:first-child');
        const select = row.querySelector('select');
        const cargo = cargoCell ? cargoCell.textContent.trim() : 'trabajador';
        let nombreEmpleado = 'este trabajador';
        if (select && select.value) {
            const empleado = empleadosDisponibles.find(emp => emp.id === select.value);
            if (empleado) nombreEmpleado = empleado.name;
        }
        if (!confirm(`¬øEst√°s seguro de eliminar a ${nombreEmpleado} (${cargo}) de la planilla?`)) return;
        row.remove();
        planillaModificada = true;
        updateModificadaIndicator();
    }

    function loadCargosForPlanilla(retryCount = 0) {
        const maxRetries = 10;
        const cargoSelect = document.getElementById('select-cargo-planilla');
        if (!cargoSelect) {
            if (retryCount < maxRetries) {
                setTimeout(() => loadCargosForPlanilla(retryCount + 1), 500);
                return;
            }
            return;
        }

        while (cargoSelect.options.length > 1) {
            cargoSelect.remove(1);
        }

        fetch('/admin/equipo/api/cargos', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            cache: 'no-cache'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.cargos && data.cargos.length > 0) {
                    const cargosActivos = data.cargos.filter(cargo => cargo.activo !== false && cargo.is_active !== false);
                    cargosActivos.forEach(cargo => {
                        const option = document.createElement('option');
                        option.value = cargo.nombre || '';
                        option.textContent = cargo.nombre || 'Sin nombre';
                        cargoSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error al cargar cargos:', error));
    }

    function loadEmpleadosEnSelector(retryCount = 0) {
        const maxRetries = 10;
        const empleadoSelect = document.getElementById('select-empleado-planilla');
        if (!empleadoSelect) {
            if (retryCount < maxRetries) {
                setTimeout(() => loadEmpleadosEnSelector(retryCount + 1), 500);
                return;
            }
            return;
        }

        while (empleadoSelect.options.length > 1) {
            empleadoSelect.remove(1);
        }

        if (empleadosDisponibles && empleadosDisponibles.length > 0) {
            empleadosDisponibles.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = emp.name || 'Sin nombre';
                empleadoSelect.appendChild(option);
            });
        }
    }

    function existeTrabajadorEnPlanilla(empleadoId, cargo) {
        const rows = document.querySelectorAll('#planilla-tbody tr');
        for (let row of rows) {
            const select = row.querySelector('select[name*="[empleado_id]"]');
            const cargoCell = row.querySelector('td:first-child');
            if (select && cargoCell) {
                const empleadoIdExistente = select.value.trim();
                const cargoExistente = cargoCell.textContent.trim();
                if (empleadoIdExistente === empleadoId && cargoExistente === cargo) {
                    return true;
                }
            }
        }
        return false;
    }

    function agregarTrabajadorDesdeFormulario() {
        const cargoSelect = document.getElementById('select-cargo-planilla');
        const empleadoSelect = document.getElementById('select-empleado-planilla');
        if (!cargoSelect || !empleadoSelect) return;

        const cargoSeleccionado = cargoSelect.value.trim();
        const empleadoIdSeleccionado = empleadoSelect.value.trim();

        if (!cargoSeleccionado || cargoSeleccionado === '') {
            alert('‚ö†Ô∏è Por favor, selecciona un cargo primero.');
            cargoSelect.focus();
            return;
        }

        if (!empleadoIdSeleccionado || empleadoIdSeleccionado === '') {
            alert('‚ö†Ô∏è Por favor, selecciona un trabajador primero.');
            empleadoSelect.focus();
            return;
        }

        if (existeTrabajadorEnPlanilla(empleadoIdSeleccionado, cargoSeleccionado)) {
            const empleadoSeleccionado = empleadosDisponibles.find(emp => emp.id === empleadoIdSeleccionado);
            const nombreEmpleado = empleadoSeleccionado ? empleadoSeleccionado.name : 'este trabajador';
            alert(`‚ö†Ô∏è ${nombreEmpleado} ya est√° asignado al cargo "${cargoSeleccionado}".`);
            return;
        }

        const empleadoSeleccionado = empleadosDisponibles.find(emp => emp.id === empleadoIdSeleccionado);
        const empleadoName = empleadoSeleccionado ? empleadoSeleccionado.name : '';

        addPlanillaRow(cargoSeleccionado, empleadoIdSeleccionado, empleadoName);
        planillaModificada = true;
        updateModificadaIndicator();
        cargoSelect.value = '';
        empleadoSelect.value = '';
        cargoSelect.focus();
    }

    function validatePlanillaForm(event) {
        const cargoSelect = document.getElementById('select-cargo-planilla');
        const empleadoSelect = document.getElementById('select-empleado-planilla');
        if (cargoSelect) cargoSelect.removeAttribute('required');
        if (empleadoSelect) empleadoSelect.removeAttribute('required');

        const tbody = document.getElementById('planilla-tbody');
        if (!tbody) {
            alert('‚ö†Ô∏è No hay trabajadores en la planilla.');
            event.preventDefault();
            return false;
        }

        const rows = tbody.querySelectorAll('tr');
        if (rows.length === 0) {
            alert('‚ö†Ô∏è La planilla est√° vac√≠a.');
            event.preventDefault();
            return false;
        }

        let filasVacias = [];
        let filasValidas = 0;

        rows.forEach((row, index) => {
            const select = row.querySelector('select[name*="[empleado_id]"]');
            if (!select) return;

            if (select.value === '' || select.value === null) {
                filasVacias.push(index + 1);
                row.style.border = '2px solid #f44336';
                row.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
                const hiddenInputs = row.querySelectorAll('input[type="hidden"]');
                hiddenInputs.forEach(input => input.remove());
            } else {
                filasValidas++;
                row.style.border = '';
                row.style.backgroundColor = '';
            }
        });

        if (filasVacias.length > 0) {
            const mensaje = filasVacias.length === 1
                ? `‚ö†Ô∏è La fila ${filasVacias[0]} no tiene un empleado seleccionado.`
                : `‚ö†Ô∏è Las filas ${filasVacias.join(', ')} no tienen empleados seleccionados.`;
            alert(mensaje);
            event.preventDefault();
            return false;
        }

        if (filasValidas === 0) {
            alert('‚ö†Ô∏è Debes seleccionar al menos un empleado.');
            event.preventDefault();
            return false;
        }

        planillaModificada = false;
        updateModificadaIndicator();
        return true;
    }

    function updateModificadaIndicator() {
        const indicator = document.getElementById('planilla-modificada-indicator');
        if (indicator) {
            indicator.style.display = planillaModificada ? 'block' : 'none';
        }
    }

    window.addEventListener('beforeunload', function (e) {
        if (planillaModificada) {
            e.preventDefault();
            e.returnValue = 'Tienes cambios sin guardar en la planilla.';
            return e.returnValue;
        }
    });

    document.addEventListener('DOMContentLoaded', async function () {
        if (!empleadosDisponibles || empleadosDisponibles.length === 0) {
            empleadosDisponibles = await getEmpleadosDisponibles();
        }
        initializePlanilla();
        updateModificadaIndicator();

        setTimeout(() => {
            const formPlanilla = document.getElementById('form-planilla');
            if (formPlanilla) {
                loadCargosForPlanilla();
                loadEmpleadosEnSelector();
                formPlanilla.addEventListener('submit', validatePlanillaForm);
            }
        }, 500);
    });

</script>
{% endblock %}